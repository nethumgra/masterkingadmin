<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Resellers - TUTU Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mudalali-green': '#3a6a4a',
                        'admin-gray': '#1f2937',
                        'ban-red': '#ef4444',
                        'tutu-rose': '#e11d48'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-link.active { @apply bg-mudalali-green text-white shadow-md; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="sidebar-container"></div>

    <main class="md:ml-64 p-8 mt-12 md:mt-0">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Manage Resellers</h1>
                <p class="text-sm text-gray-500 mt-1">Approve applications, view details & manage bans.</p>
            </div>
            
            <button onclick="fetchResellers()" class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-50 transition shadow-sm flex items-center gap-2">
                <i class="fa fa-sync-alt"></i> Refresh Data
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Total Users</p>
                <h2 class="text-2xl font-bold text-gray-800 mt-1" id="stat-total">0</h2>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Pending</p>
                <h2 class="text-2xl font-bold text-yellow-600 mt-1" id="stat-pending">0</h2>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Active</p>
                <h2 class="text-2xl font-bold text-green-600 mt-1" id="stat-active">0</h2>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-gray-400 text-xs font-bold uppercase">Banned</p>
                <h2 class="text-2xl font-bold text-red-600 mt-1" id="stat-banned">0</h2>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 min-h-[500px]">
            <div class="p-4 border-b bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-3">
                <h3 class="font-bold text-gray-700 text-sm"><i class="fa fa-list mr-2"></i>Reseller Directory</h3>
                <div class="relative w-full md:w-80">
                    <input type="text" id="search-input" class="w-full py-2 pl-9 pr-4 text-xs bg-white border rounded-lg focus:outline-none focus:border-mudalali-green" placeholder="Search Name, NIC or Shop...">
                    <i class="fa fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-gray-50 text-gray-700 uppercase text-xs font-bold border-b">
                        <tr>
                            <th class="p-4">User Info</th>
                            <th class="p-4">Shop Name</th>
                            <th class="p-4">NIC / Phone</th>
                            <th class="p-4 text-center">Status</th>
                            <th class="p-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resellers-table-body" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="5" class="p-8 text-center text-gray-400">
                                <i class="fa fa-circle-notch fa-spin text-mudalali-green text-xl mb-2"></i>
                                <p>Loading resellers...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="view-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-5xl max-h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col transform transition-all scale-100">
            <div class="bg-white px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-user-tag text-mudalali-green"></i> Reseller Application Details
                    </h3>
                    <p class="text-xs text-gray-500">Review all registration data before taking action.</p>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition flex items-center justify-center">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar bg-gray-50 flex-grow">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm text-center">
                            <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto flex items-center justify-center text-2xl font-bold text-gray-500 mb-3 border-4 border-white shadow-sm">
                                <span id="v-avatar">U</span>
                            </div>
                            <h2 id="v-fullname" class="text-lg font-bold text-gray-800">--</h2>
                            <p id="v-email" class="text-sm text-gray-500 mb-2">--</p>
                            <span id="v-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600">--</span>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h4 class="font-bold text-gray-700 text-xs uppercase mb-3 border-b pb-2">Contact Info</h4>
                            <div class="space-y-3 text-sm">
                                <div><span class="text-gray-400 block text-xs">Phone Number</span><span id="v-phone" class="font-semibold text-gray-800">--</span></div>
                                <div><span class="text-gray-400 block text-xs">NIC Number</span><span id="v-nic" class="font-semibold text-gray-800">--</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-blue-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa fa-store text-6xl text-blue-500"></i></div>
                            <h4 class="text-blue-800 font-bold mb-4 flex items-center gap-2 text-sm uppercase">
                                <i class="fa-solid fa-shop"></i> Shop/Business Details
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm relative z-10">
                                <div>
                                    <span class="text-gray-400 text-xs block mb-1">Business Name</span>
                                    <span id="v-shopname" class="font-bold text-gray-800 text-lg">--</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 text-xs block mb-1">Business Address</span>
                                    <span id="v-address" class="font-semibold text-gray-800">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-green-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa fa-bank text-6xl text-green-500"></i></div>
                            <h4 class="text-green-800 font-bold mb-4 flex items-center gap-2 text-sm uppercase">
                                <i class="fa-solid fa-money-check-dollar"></i> Bank Details
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-2 gap-4 text-sm relative z-10">
                                <div class="bg-green-50 p-2 rounded border border-green-100">
                                    <span class="text-green-600 text-[10px] font-bold uppercase block">Bank Name</span>
                                    <span id="v-bank" class="font-bold text-gray-800">--</span>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-100">
                                    <span class="text-green-600 text-[10px] font-bold uppercase block">Account Number</span>
                                    <span id="v-acc-num" class="font-mono font-bold text-gray-800">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h4 class="text-gray-600 font-bold mb-4 flex items-center gap-2 text-sm uppercase">
                                <i class="fa-solid fa-image"></i> ID Card Photos
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="text-xs font-bold text-gray-400 uppercase mb-2 block">Front Side</span>
                                    <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden border border-gray-300 relative group cursor-pointer shadow-inner" onclick="openImage(document.getElementById('v-nic-front').src)">
                                        <img id="v-nic-front" src="" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400?text=No+Image'">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center text-white opacity-0 group-hover:opacity-100 font-bold">
                                            <i class="fa fa-expand mr-2"></i> View Full Image
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xs font-bold text-gray-400 uppercase mb-2 block">Back Side</span>
                                    <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden border border-gray-300 relative group cursor-pointer shadow-inner" onclick="openImage(document.getElementById('v-nic-back').src)">
                                        <img id="v-nic-back" src="" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400?text=No+Image'">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center text-white opacity-0 group-hover:opacity-100 font-bold">
                                            <i class="fa fa-expand mr-2"></i> View Full Image
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 z-20 shadow-lg">
                <div class="text-xs text-gray-400 font-mono">UID: <span id="v-uid">--</span></div>
                <div class="flex gap-3 w-full sm:w-auto">
                    <button onclick="banReseller()" id="btn-ban" class="flex-1 sm:flex-none px-4 py-2.5 bg-white border border-red-200 text-red-600 font-bold rounded-xl hover:bg-red-50 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-ban"></i> Ban User
                    </button>
                    <button onclick="updateStatus('rejected')" id="btn-reject" class="flex-1 sm:flex-none px-4 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i> Reject
                    </button>
                    <button onclick="updateStatus('approved')" id="btn-approve" class="flex-1 sm:flex-none px-6 py-2.5 bg-mudalali-green text-white font-bold rounded-xl hover:bg-green-800 shadow-lg shadow-green-200 hover:shadow-xl transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> Approve Application
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderSidebar, checkAdminAuth, db, showToast } from "./common.js";
        import { collection, getDocs, doc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        checkAdminAuth();
        renderSidebar('manage_resellers');

        let allResellers = [];
        let currentUser = null;

        // --- 1. Fetch Data (Update Filter Logic) ---
        window.fetchResellers = async () => {
            const tbody = document.getElementById('resellers-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center"><i class="fa fa-spinner fa-spin text-2xl text-mudalali-green"></i></td></tr>';

            try {
                const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                const data = [];
                let counts = { total: 0, pending: 0, active: 0, banned: 0 };

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    
                    // Sandhya වගේ අයව අහුකරගන්න d.wantsToBeReseller හෝ d.role පරීක්ෂා කරන්න
                    if (d.shopName || d.sellerStatus || d.wantsToBeReseller || (d.role && d.role.includes('reseller'))) {
                        const r = { id: doc.id, ...d };
                        data.push(r);
                        
                        counts.total++;
                        // Status එක තීරණය කිරීම (Default pending)
                        const status = d.sellerStatus || 'pending';
                        
                        if (status === 'approved') counts.active++;
                        else if (status === 'banned') counts.banned++;
                        else counts.pending++;
                    }
                });

                allResellers = data;
                document.getElementById('stat-total').innerText = counts.total;
                document.getElementById('stat-pending').innerText = counts.pending;
                document.getElementById('stat-active').innerText = counts.active;
                document.getElementById('stat-banned').innerText = counts.banned;

                renderTable(allResellers);

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading data.</td></tr>`;
            }
        };

        // --- 2. Render Table (Update for Nested resellerDetails) ---
        function renderTable(data) {
            const tbody = document.getElementById('resellers-table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">No applications found.</td></tr>';
                return;
            }

            data.forEach(r => {
                // resellerDetails ඇතුළේ ඇති දත්ත ලබා ගැනීම
                const det = r.resellerDetails || {};
                const status = r.sellerStatus || 'pending';
                
                const displayName = r.name || 'Unknown User';
                const displayShop = r.shopName || det.shopName || 'Application Pending';
                const displayNic = r.nic || det.nic || '-';
                const displayPhone = r.phone || det.phone || '-';

                let badgeClass = '';
                let badgeIcon = '';
                let badgeText = '';

                if(status === 'approved') {
                    badgeClass = 'bg-green-100 text-green-700 border-green-200';
                    badgeIcon = 'fa-check'; badgeText = 'Active';
                } else if(status === 'rejected') {
                    badgeClass = 'bg-red-100 text-red-700 border-red-200';
                    badgeIcon = 'fa-times'; badgeText = 'Rejected';
                } else if(status === 'banned') {
                    badgeClass = 'bg-gray-800 text-white border-black';
                    badgeIcon = 'fa-ban'; badgeText = 'Banned';
                } else {
                    badgeClass = 'bg-yellow-100 text-yellow-700 border-yellow-200 animate-pulse';
                    badgeIcon = 'fa-clock'; badgeText = 'Pending';
                }

                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 transition border-b border-gray-100 last:border-0";
                row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500 uppercase">
                                ${displayName.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${displayName}</div>
                                <div class="text-xs text-gray-500">${r.email || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-gray-700 text-sm">${displayShop}</div>
                        <div class="text-xs text-gray-500 truncate w-32">${r.shopAddress || det.address || '-'}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600 font-mono">
                        <div><i class="fa fa-id-card text-gray-300 mr-1"></i> ${displayNic}</div>
                        <div><i class="fa fa-phone text-gray-300 mr-1"></i> ${displayPhone}</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeClass}">
                            <i class="fa-solid ${badgeIcon} mr-1"></i> ${badgeText}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="window.viewDetails('${r.id}')" class="bg-white border border-gray-300 text-gray-600 hover:border-mudalali-green hover:text-mudalali-green px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm">
                            View & Manage
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- 3. View Modal Logic (Update Field Mapping) ---
        window.viewDetails = (uid) => {
            const r = allResellers.find(x => x.id === uid);
            if(!r) return;
            currentUser = r;
            const det = r.resellerDetails || {};

            const set = (id, val) => document.getElementById(id).textContent = val || '--';
            const setImg = (id, url) => document.getElementById(id).src = url || 'https://placehold.co/600x400?text=No+Image';

            set('v-avatar', r.name ? r.name.charAt(0).toUpperCase() : 'U');
            set('v-fullname', r.name);
            set('v-email', r.email);
            set('v-phone', r.phone || det.phone);
            set('v-nic', r.nic || det.nic);
            set('v-uid', r.id);
            set('v-shopname', r.shopName || det.shopName || 'Reseller Registration');
            set('v-address', r.shopAddress || det.address || r.address || '--');

            // Bank Mapping (Screenshot එක අනුව det.bank සහ det.accountNo පාවිච්චි වේ)
            set('v-bank', det.bank || r.bankName);
            set('v-acc-num', det.accountNo || r.accountNumber);

            // Images
            setImg('v-nic-front', det.nicFrontUrl || r.nicFrontUrl);
            setImg('v-nic-back', det.nicBackUrl || r.nicBackUrl);

            // Button Control
            const status = r.sellerStatus || 'pending';
            document.getElementById('v-status-badge').textContent = status.toUpperCase();
            
            const btnApprove = document.getElementById('btn-approve');
            const btnReject = document.getElementById('btn-reject');
            const btnBan = document.getElementById('btn-ban');

            if (status === 'approved') {
                btnApprove.classList.add('hidden');
                btnReject.classList.remove('hidden');
            } else if (status === 'banned') {
                btnApprove.classList.remove('hidden');
                btnReject.classList.add('hidden');
                btnBan.textContent = "Un-Ban User";
            } else {
                btnApprove.classList.remove('hidden');
                btnReject.classList.remove('hidden');
                btnBan.textContent = "Ban User";
            }

            document.getElementById('view-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('view-modal').classList.add('hidden');
        window.openImage = (url) => { if(url && !url.includes('placehold.co')) window.open(url, '_blank'); };

        // --- 4. Actions ---
        window.updateStatus = async (status) => {
            if(!currentUser) return;
            const isApprove = status === 'approved';
            const result = await Swal.fire({
                title: isApprove ? 'Approve Reseller?' : 'Reject Application?',
                text: isApprove ? "They will gain access to reseller prices." : "This application will be rejected.",
                icon: isApprove ? 'success' : 'warning',
                showCancelButton: true,
                confirmButtonColor: isApprove ? '#3a6a4a' : '#d33',
                confirmButtonText: isApprove ? 'Yes, Approve' : 'Yes, Reject'
            });

            if(result.isConfirmed) performUpdate(status, isApprove);
        };

        window.banReseller = async () => {
            if(!currentUser) return;
            const isCurrentlyBanned = currentUser.sellerStatus === 'banned';
            const result = await Swal.fire({
                title: isCurrentlyBanned ? 'Un-Ban User?' : 'BAN USER?',
                text: isCurrentlyBanned ? "Restore user access?" : "This will immediately revoke all access.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: isCurrentlyBanned ? '#3a6a4a' : '#000',
                confirmButtonText: isCurrentlyBanned ? 'Yes, Un-Ban' : 'Yes, BAN NOW'
            });

            if(result.isConfirmed) {
                const newStatus = isCurrentlyBanned ? 'pending' : 'banned';
                performUpdate(newStatus, false);
            }
        };

        async function performUpdate(status, isSellerBool) {
            try {
                Swal.fire({ title: 'Updating...', didOpen: () => Swal.showLoading() });
                
                // Approve කරනවා නම් role එක 'reseller' වලටත් update කළ යුතුය
                let updateData = {
                    sellerStatus: status,
                    isSeller: isSellerBool
                };

                if (status === 'approved') {
                    updateData.role = 'reseller';
                } else if (status === 'rejected') {
                    updateData.role = 'customer';
                }

                await updateDoc(doc(db, 'users', currentUser.id), updateData);

                // Local Update
                const idx = allResellers.findIndex(x => x.id === currentUser.id);
                if(idx !== -1) {
                    allResellers[idx].sellerStatus = status;
                    allResellers[idx].isSeller = isSellerBool;
                    if(updateData.role) allResellers[idx].role = updateData.role;
                }
                
                renderTable(allResellers);
                closeModal();
                fetchResellers(); 

                Swal.fire({ icon: 'success', title: 'Action Successful!', timer: 1000, showConfirmButton: false });

            } catch (e) {
                console.error(e);
                showToast('Action failed', 'error');
            }
        }

        // Search update (looking into resellerDetails as well)
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allResellers.filter(r => {
                const det = r.resellerDetails || {};
                return (r.name && r.name.toLowerCase().includes(term)) ||
                       (r.shopName && r.shopName.toLowerCase().includes(term)) ||
                       (det.shopName && det.shopName.toLowerCase().includes(term)) ||
                       (r.nic && r.nic.toLowerCase().includes(term)) ||
                       (det.nic && det.nic.toLowerCase().includes(term));
            });
            renderTable(filtered);
        });

        fetchResellers();
    </script>
</body>
</html>