<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Mudalali Mama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { 'mudalali-green': '#3a6a4a', 'ai-purple': '#8b5cf6' } 
                } 
            }
        }
    </script>
    <style>
        .sidebar-link.active { @apply bg-mudalali-green text-white shadow-md; }
        .radar-scan {
            position: relative;
            overflow: hidden;
        }
        .radar-scan::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            animation: scan 2s infinite;
        }
        @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }
        
        /* Custom Toggle Switch Colors */
        .peer-checked:bg-mudalali-green { background-color: #3a6a4a; }
        .peer-checked:bg-blue-600 { background-color: #2563eb; }
        .peer-checked:bg-orange-500 { background-color: #f97316; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="sidebar-container"></div>

    <main class="md:ml-64 p-8 mt-12 md:mt-0">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">System Settings</h1>
                <p class="text-sm text-gray-500">Platform Control Center & AI Intelligence</p>
            </div>
            <div id="system-health-badge" class="px-4 py-2 bg-gray-200 rounded-full text-xs font-bold text-gray-500 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-gray-400"></span> System Status: Unknown
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-gradient-to-br from-indigo-900 to-blue-800 p-6 rounded-xl shadow-lg text-white border border-indigo-700 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fa fa-shield-halved text-9xl"></i>
                </div>
                
                <div class="flex items-center gap-3 mb-4 relative z-10">
                    <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-cyan-300 backdrop-blur-sm">
                        <i class="fa fa-user-secret text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">AI Security Sentinel</h2>
                        <p class="text-xs text-indigo-200">Real-time Threat Analysis</p>
                    </div>
                </div>

                <div class="space-y-4 relative z-10">
                    <p class="text-sm text-indigo-100 opacity-90">
                        Use AI to scan your platform configurations, API usage, and maintenance status to detect potential vulnerabilities.
                    </p>
                    
                    <div id="scan-result-area" class="hidden bg-black/20 rounded-lg p-3 text-sm border border-white/10">
                        <p id="scan-text" class="text-gray-200">Waiting for scan...</p>
                    </div>

                    <button onclick="runSecurityScan()" id="scan-btn" class="w-full bg-cyan-500 hover:bg-cyan-400 text-white py-3 rounded-lg font-bold shadow-lg shadow-cyan-500/30 transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                        <i class="fa fa-radar"></i> Run System Audit
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                    <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                        <i class="fa fa-cash-register text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Payment & Operations</h2>
                        <p class="text-xs text-gray-500">Control Payment Methods & Logistics</p>
                    </div>
                </div>

                <div class="space-y-5">
                    
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-3">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Active Payment Methods</h3>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fa fa-truck text-gray-500"></i>
                                <span class="text-sm font-semibold text-gray-700">Cash on Delivery (COD)</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="cod-toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-mudalali-green"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fa fa-credit-card text-gray-500"></i>
                                <span class="text-sm font-semibold text-gray-700">Online Payment (Gateway)</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="online-pay-toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fa fa-university text-gray-500"></i>
                                <span class="text-sm font-semibold text-gray-700">Bank Transfer / Deposit</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="bank-pay-toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500"></div>
                            </label>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="cod-verification-check" class="h-4 w-4 text-blue-600 rounded cursor-pointer">
                            <label for="cod-verification-check" class="text-xs font-bold text-blue-800 cursor-pointer">Strict Verification Mode</label>
                        </div>
                        <p class="text-[10px] text-blue-600 leading-tight">
                            If enabled, all COD orders will be marked as <span class="font-bold">"Pending Verification"</span>. Sellers must manually confirm the order (call customer) before processing.
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Max COD Limit (LKR)</label>
                            <input type="number" id="max-cod-limit" class="w-full p-2 border rounded text-xs" placeholder="e.g. 20000">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Shipping Fee (LKR)</label>
                            <input type="number" id="base-shipping-fee" class="w-full p-2 border rounded text-xs" placeholder="e.g. 350">
                        </div>
                    </div>

                    <button onclick="saveBusinessSettings()" id="save-biz-btn" class="w-full bg-orange-600 text-white hover:bg-orange-700 py-2.5 rounded-lg font-bold text-sm transition shadow">
                        Save Payment Rules
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                        <i class="fa fa-robot text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Gemini AI Config</h2>
                        <p class="text-xs text-gray-500">Failover System</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-purple-700 uppercase mb-1">Primary API Key</label>
                        <div class="relative">
                            <input type="password" id="gemini-key" class="w-full p-2 pl-8 border border-purple-200 rounded text-sm bg-purple-50/30">
                            <i class="fa fa-key absolute left-2.5 top-2.5 text-purple-400 text-xs"></i>
                            <button onclick="toggleVisibility('gemini-key')" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"><i class="fa fa-eye"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Backup API Key</label>
                        <div class="relative">
                            <input type="password" id="gemini-key-backup" class="w-full p-2 pl-8 border border-gray-300 rounded text-sm">
                            <i class="fa fa-shield-alt absolute left-2.5 top-2.5 text-gray-400 text-xs"></i>
                            <button onclick="toggleVisibility('gemini-key-backup')" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"><i class="fa fa-eye"></i></button>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Selected Model</label>
                            <button onclick="fetchAIModels()" id="fetch-models-btn" class="text-[10px] text-purple-600 font-bold hover:text-purple-800"><i class="fa fa-sync-alt"></i> Refresh</button>
                        </div>
                        <select id="ai-model-select" class="w-full p-2 border rounded text-sm"><option value="gemini-1.5-flash">gemini-1.5-flash</option></select>
                    </div>
                    <button onclick="saveAIConfig()" class="w-full bg-gray-800 text-white py-2 rounded font-bold text-sm">Save AI Config</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fa fa-percent text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Commission Rates</h2>
                        <p class="text-xs text-gray-500">Revenue Control</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Global Rate (%)</label>
                        <input type="number" id="global-commission" class="w-full p-2 border border-gray-300 rounded text-sm">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Category Rules</label>
                        <div id="category-rates-container" class="space-y-2 mb-2"></div>
                        <button onclick="addRateRow()" class="text-[10px] flex items-center gap-1 font-bold text-blue-600 hover:text-blue-800"><i class="fa fa-plus-circle"></i> Add Rule</button>
                    </div>
                    <button onclick="savePlatformSettings()" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold text-sm hover:bg-gray-900">Update Rates</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                        <i class="fa fa-file-contract text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Legal AI Writer</h2>
                        <p class="text-xs text-gray-500">Generate Policies</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <select id="policy-type" class="w-full p-2 border rounded text-sm">
                        <option value="Privacy Policy">Privacy Policy</option>
                        <option value="Terms of Service">Terms of Service</option>
                        <option value="Refund Policy">Refund Policy</option>
                    </select>
                    <button onclick="generatePolicy()" id="gen-policy-btn" class="w-full bg-green-600 text-white py-2 rounded font-bold text-sm hover:bg-green-700 flex items-center justify-center gap-2">
                        <i class="fa fa-pen-nib"></i> Generate & Download
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100">
                    <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center text-teal-600">
                        <i class="fa fa-headset text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Contact Settings</h2>
                        <p class="text-xs text-gray-500">Header Hotline</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Header Hotline Number</label>
                        <input type="text" id="hotline-number" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="e.g. 077 123 4567">
                    </div>
                    <button onclick="saveContactSettings()" id="save-contact-btn" class="w-full bg-teal-600 text-white py-2 rounded font-bold text-sm hover:bg-teal-700 transition">
                        Update Contact Info
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 bg-red-50 p-6 rounded-xl shadow-sm border border-red-200 mt-2 transition-all duration-300">
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-red-100">
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                        <i class="fa fa-triangle-exclamation text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-red-700">Danger Zone</h2>
                        <p class="text-xs text-red-500">Emergency Maintenance</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">Public Access</h3>
                            <p class="text-xs text-gray-600">Close store for everyone except admins.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="maintenance-toggle" class="sr-only peer" onchange="toggleMaintenanceMode()">
                            <div class="w-12 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <div id="maintenance-status-display" class="text-xs font-bold text-gray-500 text-right">STATUS: NORMAL</div>
                    <div id="maintenance-msg-area" class="hidden bg-white p-4 rounded-lg border border-red-100 mt-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reason (Internal)</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="shutdown-reason" class="flex-grow p-2 border rounded text-sm" placeholder="e.g. Hacking attempt...">
                            <button onclick="generateMaintenanceMessage()" id="gen-msg-btn" class="bg-purple-600 text-white px-3 py-2 rounded text-xs font-bold flex items-center gap-1 hover:bg-purple-700">AI Write</button>
                        </div>
                        <textarea id="public-message" rows="2" class="w-full p-2 border rounded text-sm bg-gray-50 mb-2"></textarea>
                        <button onclick="saveMaintenanceMessage()" class="w-full bg-red-600 text-white py-2 rounded font-bold text-xs hover:bg-red-700">Update Notice</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

  <script type="module">
        import { renderSidebar, checkAdminAuth, db } from "./common.js";
        import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        checkAdminAuth();
        renderSidebar('settings');

        // --- Paths & References ---
        // Index.html eka use karana path ekama methanata gannawa
        const appId = 'default-app-id'; // Oyaage App ID eka methana thiyenna one (index.html eke logic eka anuwa)
        const publicDataPath = `/artifacts/${appId}/public/data`;

        const aiConfigRef = doc(db, 'config', 'ai_keys');
        const platformConfigRef = doc(db, 'config', 'platform_settings');
        
        // MENNA ALUTH PATH EKA: Index.html eka hotline eka ganne methanin
        const siteConfigRef = doc(db, publicDataPath, 'siteContent', 'config');

        // --- Load Settings ---
        async function loadSettings() {
            try {
                // 1. Load Hotline (From Site Config - same as index.html)
                const siteSnap = await getDoc(siteConfigRef);
                if (siteSnap.exists()) {
                    const data = siteSnap.data();
                    // Index.html uses 'headerHotline'
                    document.getElementById('hotline-number').value = data.headerHotline || '';
                }

                // 2. AI Settings
                const aiSnap = await getDoc(aiConfigRef);
                if (aiSnap.exists()) {
                    const data = aiSnap.data();
                    document.getElementById('gemini-key').value = data.geminiKey || '';
                    document.getElementById('gemini-key-backup').value = data.geminiKeyBackup || '';
                    if(data.preferredModel) {
                        const select = document.getElementById('ai-model-select');
                        if(![...select.options].some(o => o.value === data.preferredModel)) {
                            const opt = document.createElement('option'); opt.value = data.preferredModel; opt.text = data.preferredModel + " (Saved)"; select.add(opt);
                        }
                        select.value = data.preferredModel;
                    }
                }

                // 3. Platform Settings (Payments, Maintenance, etc.)
                const platSnap = await getDoc(platformConfigRef);
                if (platSnap.exists()) {
                    const data = platSnap.data();
                    
                    // Business Ops - Payments
                    document.getElementById('cod-toggle').checked = data.codEnabled !== false;
                    document.getElementById('online-pay-toggle').checked = data.onlinePaymentEnabled !== false;
                    document.getElementById('bank-pay-toggle').checked = data.bankTransferEnabled !== false;
                    document.getElementById('cod-verification-check').checked = data.codVerificationRequired || false;
                    
                    document.getElementById('max-cod-limit').value = data.maxCodLimit || '';
                    document.getElementById('base-shipping-fee').value = data.shippingFee || '';

                    // Commissions
                    document.getElementById('global-commission').value = data.globalCommission || 5;
                    const container = document.getElementById('category-rates-container');
                    container.innerHTML = ''; 
                    if (data.categoryRates) data.categoryRates.forEach(rate => addRateRow(rate.category, rate.rate));

                    // Maintenance
                    const isMaint = data.isMaintenanceMode || false;
                    document.getElementById('maintenance-toggle').checked = isMaint;
                    updateMaintenanceUI(isMaint);
                    if (data.maintenanceMessage) document.getElementById('public-message').value = data.maintenanceMessage;

                    updateSystemHealthBadge(isMaint);
                }
            } catch (e) { console.error("Error loading settings:", e); }
        }

        // --- SAVE Contact Settings (Matches index.html path) ---
        window.saveContactSettings = async () => {
            const btn = document.getElementById('save-contact-btn');
            const hotline = document.getElementById('hotline-number').value;
            
            btn.innerHTML = 'Saving...'; btn.disabled = true;

            try {
                // Methana save karanne 'siteConfigRef' ekata (index.html eka read karana thana)
                // Field eka 'headerHotline' wenna one index.html eka anuwa
                await setDoc(siteConfigRef, { 
                    headerHotline: hotline,
                    updatedAt: serverTimestamp() 
                }, { merge: true });

                Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: 'Hotline number updated for the website.',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch(e) {
                console.error(e);
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.innerHTML = 'Update Contact Info'; btn.disabled = false;
            }
        };

        // --- Save Payment & Business Logic ---
        window.saveBusinessSettings = async () => {
            const btn = document.getElementById('save-biz-btn');
            const codEnabled = document.getElementById('cod-toggle').checked;
            const onlineEnabled = document.getElementById('online-pay-toggle').checked;
            const bankEnabled = document.getElementById('bank-pay-toggle').checked;
            const codVerify = document.getElementById('cod-verification-check').checked;
            const maxCod = Number(document.getElementById('max-cod-limit').value);
            const shipping = Number(document.getElementById('base-shipping-fee').value);
            
            btn.innerHTML = 'Saving...'; btn.disabled = true;

            try {
                await setDoc(platformConfigRef, {
                    codEnabled: codEnabled,
                    onlinePaymentEnabled: onlineEnabled,
                    bankTransferEnabled: bankEnabled,
                    codVerificationRequired: codVerify,
                    maxCodLimit: maxCod,
                    shippingFee: shipping,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                Swal.fire('Success', 'Payment Rules Updated!', 'success');
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.innerHTML = 'Save Payment Rules'; btn.disabled = false;
            }
        };

        // --- Helper: Key Switcher (Failover) ---
        async function executeGeminiRequest(urlSuffix, method = 'GET', body = null) {
            const mainKey = document.getElementById('gemini-key').value.trim();
            const backupKey = document.getElementById('gemini-key-backup').value.trim();
            if (!mainKey) throw new Error("Main API Key missing.");

            const makeCall = async (key) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/${urlSuffix}?key=${key}`;
                const options = { method: method };
                if (body) { options.headers = {'Content-Type': 'application/json'}; options.body = JSON.stringify(body); }
                const res = await fetch(url, options);
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error?.message || res.statusText);
                return data;
            };

            try {
                return await makeCall(mainKey);
            } catch (error) {
                if (backupKey) {
                    console.warn("Switching to backup key...");
                    return await makeCall(backupKey);
                }
                throw error;
            }
        }

        // --- Existing Functions ---
        function updateSystemHealthBadge(isMaintenance) {
            const badge = document.getElementById('system-health-badge');
            if(isMaintenance) {
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Mode: Emergency';
                badge.className = "px-4 py-2 bg-red-100 rounded-full text-xs font-bold text-red-600 flex items-center gap-2";
            } else {
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Mode: Operational';
                badge.className = "px-4 py-2 bg-green-100 rounded-full text-xs font-bold text-green-600 flex items-center gap-2";
            }
        }

        window.fetchAIModels = async () => {
            try {
                const data = await executeGeminiRequest('models', 'GET');
                const select = document.getElementById('ai-model-select');
                if (!data.models) throw new Error("No models found.");
                const models = data.models.filter(m => m.name.includes('gemini') && m.supportedGenerationMethods?.includes('generateContent'));
                select.innerHTML = '';
                models.forEach(m => {
                    const name = m.name.replace('models/', '');
                    const opt = document.createElement('option'); opt.value = name; opt.text = name; select.add(opt);
                });
                alert("âœ… Models Refreshed");
            } catch (e) { alert(e.message); }
        };

        window.runSecurityScan = async () => {
            const btn = document.getElementById('scan-btn');
            const resArea = document.getElementById('scan-result-area');
            const resText = document.getElementById('scan-text');
            const model = document.getElementById('ai-model-select').value || 'gemini-1.5-flash';
            
            btn.innerHTML = 'Scanning...'; btn.classList.add('radar-scan'); resArea.classList.remove('hidden');
            
            const codStat = document.getElementById('cod-toggle').checked;
            const maint = document.getElementById('maintenance-toggle').checked;
            
            const prompt = `Cyber Security Audit. Maintenance=${maint}, COD_Active=${codStat}. Assess risks in 30 words. Score /10.`;
            
            try {
                const data = await executeGeminiRequest(`models/${model}:generateContent`, 'POST', { contents: [{ parts: [{ text: prompt }] }] });
                resText.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
            } catch(e) { resText.textContent = "Error: " + e.message; }
            finally { btn.innerHTML = 'Run System Audit'; btn.classList.remove('radar-scan'); }
        };

        // --- Save AI & Platform ---
        window.saveAIConfig = async () => {
            const k1 = document.getElementById('gemini-key').value;
            const k2 = document.getElementById('gemini-key-backup').value;
            const mod = document.getElementById('ai-model-select').value;
            try { await setDoc(aiConfigRef, { geminiKey: k1, geminiKeyBackup: k2, preferredModel: mod }, { merge: true }); alert("âœ… Saved"); } catch(e){ alert(e.message); }
        };

        window.savePlatformSettings = async () => {
            const rate = document.getElementById('global-commission').value;
            const catRates = [];
            document.querySelectorAll('.rate-row').forEach(r => {
                const c = r.querySelector('.cat-name').value; const v = r.querySelector('.cat-rate').value;
                if(c) catRates.push({category: c, rate: Number(v)});
            });
            try { await setDoc(platformConfigRef, { globalCommission: Number(rate), categoryRates: catRates }, { merge: true }); alert("âœ… Saved"); } catch(e){ alert(e.message); }
        };

        window.toggleMaintenanceMode = async () => {
            const isChecked = document.getElementById('maintenance-toggle').checked;
            if(isChecked && !confirm("Site will close. Proceed?")) { document.getElementById('maintenance-toggle').checked = false; return; }
            await setDoc(platformConfigRef, { isMaintenanceMode: isChecked }, { merge: true });
            updateMaintenanceUI(isChecked); updateSystemHealthBadge(isChecked);
        };
        
        function updateMaintenanceUI(isMaint) {
            const area = document.getElementById('maintenance-msg-area');
            const status = document.getElementById('maintenance-status-display');
            if(isMaint) { area.classList.remove('hidden'); status.textContent = "STATUS: ðŸ”´ CLOSED"; status.className = "text-xs font-bold text-red-600 animate-pulse text-right"; }
            else { area.classList.add('hidden'); status.textContent = "STATUS: ðŸŸ¢ NORMAL"; status.className = "text-xs font-bold text-green-600 text-right"; }
        }

        window.saveMaintenanceMessage = async () => { 
            const msg = document.getElementById('public-message').value;
            try { await setDoc(platformConfigRef, { maintenanceMessage: msg }, { merge: true }); alert("Notice Updated"); } catch(e) { alert("Error"); }
        };

        window.generateMaintenanceMessage = async () => { /* ... existing ... */ };
        window.generatePolicy = async () => { /* ... existing ... */ };

        window.addRateRow = (c='',r='') => {
             const div = document.createElement('div'); div.className='flex gap-2 rate-row';
             div.innerHTML=`<input class='cat-name border p-1 rounded text-xs w-full' placeholder='Cat' value='${c}'><input class='cat-rate border p-1 rounded text-xs w-16' type='number' value='${r}'><button onclick='this.parentElement.remove()' class='text-red-500'><i class='fa fa-times'></i></button>`;
             document.getElementById('category-rates-container').appendChild(div);
        };
        window.toggleVisibility = (id) => { const i = document.getElementById(id); i.type = i.type==='password'?'text':'password'; };

        loadSettings();
    </script>
</body>
</html>