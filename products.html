<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Manager (Voice, Vision & Variations) - TUTU Admin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'tutu-pink': { DEFAULT: '#db2777', dark: '#be185d', light: '#fbcfe8' },
                        'ai-purple': '#8b5cf6',
                        'risk-red': '#dc2626'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-link.active { @apply bg-tutu-pink text-white shadow-md; }
        .magic-btn {
            background: linear-gradient(45deg, #db2777, #a855f7, #ec4899);
            background-size: 200% 200%;
            animation: gradient-xy 3s ease infinite;
        }
        @keyframes gradient-xy { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-thumb { background-color: #fbcfe8; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background-color: #db2777; }
        .score-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 3px solid #eee; }
        .score-high { border-color: #22c55e; color: #15803d; background: #f0fdf4; }
        .score-mid { border-color: #eab308; color: #a16207; background: #fefce8; }
        .score-low { border-color: #ef4444; color: #b91c1c; background: #fef2f2; }
        .mic-listening { animation: pulse-red 1.5s infinite; background-color: #fee2e2 !important; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .upload-overlay { transition: all 0.3s ease; opacity: 0; }
        .group:hover .upload-overlay { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="sidebar-container"></div>

    <main class="md:ml-64 p-8 mt-12 md:mt-0">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Product Command Center</h1>
                <p class="text-sm text-tutu-pink font-medium">TUTU AI Scoring & Optimization System</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openCreateModal()" class="bg-tutu-pink text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-tutu-pink-dark hover:shadow-xl transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fa fa-plus-circle"></i> Create Product
                </button>
                <button onclick="refreshStats()" class="text-xs font-bold text-gray-500 hover:text-tutu-pink hover:underline transition-colors flex items-center gap-1 bg-white px-3 py-2 rounded-lg border border-gray-200 shadow-sm">
                    <i class="fa fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-yellow-500 transition hover:shadow-md">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Pending Review</p>
                <h2 class="text-3xl font-bold mt-1 text-yellow-600" id="stat-pending">...</h2>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500 transition hover:shadow-md">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Live Products</p>
                <h2 class="text-3xl font-bold mt-1 text-green-600" id="stat-live">...</h2>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-500 transition hover:shadow-md">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Rejected</p>
                <h2 class="text-3xl font-bold mt-1 text-red-600" id="stat-rejected">...</h2>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-tutu-pink transition hover:shadow-md">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">New This Week</p>
                <h2 class="text-3xl font-bold mt-1 text-tutu-pink" id="stat-week">...</h2>
            </div>
        </div>

        <div class="bg-white p-5 rounded-t-2xl border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm z-10 sticky top-20 md:top-0">
            <div class="relative w-full md:w-80">
                <i class="fa fa-search absolute left-3 top-3.5 text-gray-400"></i>
                <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none transition-all bg-pink-50/20" placeholder="Search loaded products...">
            </div>
            <div class="flex gap-3 flex-wrap md:flex-nowrap w-full md:w-auto">
                <div class="relative">
                    <select id="category-filter" class="appearance-none p-2.5 pr-8 border border-gray-200 rounded-xl bg-gray-50 outline-none text-sm font-semibold text-gray-600 focus:ring-2 focus:ring-tutu-pink cursor-pointer w-full" onchange="filterProducts()">
                        <option value="all">All Categories</option>
                    </select>
                    <i class="fa fa-chevron-down absolute right-3 top-3.5 text-xs text-gray-400 pointer-events-none"></i>
                </div>
                <div class="relative">
                    <select id="status-filter" class="appearance-none p-2.5 pr-8 border border-gray-200 rounded-xl bg-gray-50 outline-none text-sm font-semibold text-gray-600 focus:ring-2 focus:ring-tutu-pink cursor-pointer w-full" onchange="filterProducts()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Live</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <i class="fa fa-chevron-down absolute right-3 top-3.5 text-xs text-gray-400 pointer-events-none"></i>
                </div>
                <button onclick="resetAndReload()" class="bg-white border border-gray-200 text-gray-500 px-4 py-2.5 rounded-xl font-bold hover:text-tutu-pink hover:border-tutu-pink transition-all shadow-sm">
                    <i class="fa fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-b-2xl shadow-sm overflow-hidden min-h-[500px] border border-gray-100 border-t-0">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-pink-50/50 text-gray-700 uppercase text-xs font-bold border-b border-pink-100 sticky top-0">
                    <tr>
                        <th class="p-4">Product Info</th>
                        <th class="p-4">Category</th>
                        <th class="p-4 text-center">Quality Score</th>
                        <th class="p-4 text-center">Status</th>
                        <th class="p-4 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body" class="divide-y divide-gray-100"></tbody>
            </table>
            <div id="scroll-loader" class="p-6 text-center hidden">
                <i class="fa fa-spinner fa-spin text-2xl text-tutu-pink"></i>
                <p class="text-xs text-gray-400 mt-2 font-medium">Fetching more products...</p>
            </div>
            <div id="end-of-list" class="p-6 text-center text-gray-300 text-xs hidden font-bold tracking-widest uppercase">-- End of List --</div>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-md transition-opacity">
        <div class="bg-white w-full max-w-6xl h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row transform transition-transform scale-100 my-4">
            
            <div class="w-full md:w-1/3 bg-gray-900 flex flex-col p-6 relative border-r border-gray-800 overflow-y-auto custom-scrollbar">
                <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fa fa-robot text-ai-purple"></i> AI Audit</h3>
                
                <div class="relative group w-full aspect-square bg-black rounded-xl overflow-hidden border border-gray-700 mb-4 shadow-lg flex items-center justify-center cursor-pointer" onclick="document.getElementById('image-upload-input').click()">
                    <img id="edit-img" src="https://placehold.co/400?text=Click+to+Upload" class="w-full h-full object-contain z-0">
                    <div id="upload-overlay" class="upload-overlay absolute inset-0 bg-black/70 flex flex-col items-center justify-center text-white z-10">
                        <i class="fa fa-cloud-upload-alt text-4xl mb-2 text-tutu-pink"></i>
                        <span class="text-sm font-bold">Click to Upload Image</span>
                    </div>
                    <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                </div>
                <input type="hidden" id="edit-img-url">
                <p id="upload-status" class="text-center text-xs font-bold mb-4 h-5 text-tutu-pink animate-pulse hidden">Uploading to ImgBB...</p>

                <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700 shadow-inner">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-400 text-xs uppercase font-bold tracking-wider">Quality Score</span>
                        <span id="modal-score-val" class="text-2xl font-bold text-white">0/100</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-4 overflow-hidden">
                        <div id="modal-score-bar" class="bg-green-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <div class="space-y-2" id="modal-audit-list"></div>
                </div>
            </div>

            <div class="w-full md:w-2/3 flex flex-col">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                    <div class="flex items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Product Details</h2>
                            <p class="text-xs text-gray-400 font-mono mt-0.5">ID: <span id="modal-id">...</span></p>
                        </div>
                        <button onclick="magicFixProductVision()" id="btn-magic-fix" class="magic-btn text-white px-4 py-2 rounded-full font-bold shadow-md hover:shadow-lg hover:scale-105 transition flex items-center gap-2 text-xs border border-white/20">
                            <i class="fa fa-wand-magic-sparkles"></i> AI Auto-Fill (Image + Voice)
                        </button>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-2xl transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">&times;</button>
                </div>

                <div class="p-6 overflow-y-auto modal-scroll flex-grow space-y-5 bg-white">
                    
                    <div class="bg-pink-50/50 p-4 rounded-2xl border border-pink-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-tutu-pink uppercase tracking-wide"><i class="fa fa-microphone mr-1"></i> Voice Notes (Sinhala/English)</label>
                            <button id="mic-btn" onclick="toggleVoiceRecognition()" class="bg-white text-gray-500 border border-gray-200 px-3 py-1 rounded-full text-xs font-bold hover:text-tutu-pink hover:border-tutu-pink transition-all flex items-center gap-1">
                                <i class="fa fa-microphone-slash" id="mic-icon"></i> <span id="mic-text">Start Mic</span>
                            </button>
                        </div>
                        <textarea id="voice-input" rows="2" class="w-full p-3 border border-pink-200 rounded-xl text-sm focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none transition-all resize-none bg-white text-gray-600" placeholder="Speak details here... (e.g., 'Red saree, price 5000, Blue one 6000')"></textarea>
                        <p class="text-xs text-gray-400 mt-1 ml-1">Tip: Speak details including variations, then click "AI Auto-Fill".</p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Product Name</label>
                            <input type="text" id="edit-name" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none font-bold text-gray-800 bg-gray-50/50 transition-all" placeholder="Auto-generated by AI">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Category</label>
                            <input type="text" id="edit-category" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none transition-all" placeholder="e.g. Electronics">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Price (LKR)</label>
                            <input type="number" id="edit-price" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none font-mono font-bold text-tutu-pink bg-pink-50/10">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Original Price</label>
                            <input type="number" id="edit-orig-price" class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none font-mono text-gray-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">Min Price (Hidden)</label>
                            <input type="number" id="edit-min-price" class="w-full p-3 border border-red-200 bg-red-50/50 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none font-mono text-red-600">
                        </div>
                    </div>

                    <div class="relative">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide">Description</label>
                            <span id="ai-status" class="text-xs text-ai-purple hidden animate-pulse font-bold bg-purple-50 px-2 py-0.5 rounded-md">âœ¨ AI is processing...</span>
                        </div>
                        <textarea id="edit-desc" rows="3" class="w-full p-4 border border-gray-200 rounded-xl text-sm leading-relaxed focus:ring-2 focus:ring-tutu-pink focus:border-transparent outline-none transition-all resize-none bg-gray-50/30" placeholder="Auto-generated description will appear here."></textarea>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 mt-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-3 tracking-wide flex items-center gap-2">
                            <i class="fa fa-layer-group text-tutu-pink"></i> Product Variations (Color/Size)
                        </label>
                        
                        <div id="variations-list" class="space-y-3 mb-4">
                            </div>

                        <div class="grid grid-cols-12 gap-2 items-end bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <div class="col-span-3">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Name (e.g. Red)</label>
                                <input type="text" id="var-name-input" class="w-full p-2 border border-gray-200 rounded-lg text-xs font-bold focus:ring-1 focus:ring-tutu-pink outline-none" placeholder="Name">
                            </div>
                            <div class="col-span-3">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Price Override</label>
                                <input type="number" id="var-price-input" class="w-full p-2 border border-gray-200 rounded-lg text-xs font-bold focus:ring-1 focus:ring-tutu-pink outline-none" placeholder="Same as Main">
                            </div>
                            <div class="col-span-4">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Image (Optional)</label>
                                <div class="flex gap-1">
                                    <input type="file" id="var-img-input" class="hidden" accept="image/*">
                                    <button onclick="document.getElementById('var-img-input').click()" class="w-full bg-gray-100 border border-gray-200 text-gray-500 text-xs py-2 rounded-lg hover:bg-gray-200 truncate" id="var-img-btn-text">
                                        <i class="fa fa-camera"></i> Choose
                                    </button>
                                </div>
                            </div>
                            <div class="col-span-2">
                                <button onclick="addManualVariation()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-black transition">
                                    <i class="fa fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-8 p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="edit-custom" class="w-5 h-5 text-tutu-pink rounded border-gray-300 focus:ring-tutu-pink transition-all">
                            <span class="text-sm font-bold text-gray-600 group-hover:text-tutu-pink transition-colors">Customization Available</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="edit-active" class="w-5 h-5 text-tutu-pink rounded border-gray-300 focus:ring-tutu-pink transition-all">
                            <span class="text-sm font-bold text-gray-600 group-hover:text-tutu-pink transition-colors">Listing Active</span>
                        </label>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-100 bg-white flex justify-between items-center rounded-br-2xl">
                    <button onclick="deleteProduct()" class="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-2 border border-red-200 px-4 py-2.5 rounded-xl hover:bg-red-50 transition-all">
                        <i class="fa fa-trash"></i> Delete
                    </button>
                    <div class="flex gap-3">
                        <button onclick="saveChanges(false)" class="px-6 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors flex items-center gap-2">
                            <i class="fa fa-save"></i> Save Draft
                        </button>
                        <button onclick="updateProductStatus('rejected')" class="px-6 py-2.5 bg-white border border-red-200 text-red-600 font-bold rounded-xl hover:bg-red-50 transition-colors flex items-center gap-2">
                            <i class="fa fa-times-circle"></i> Reject
                        </button>
                        <button onclick="saveChanges(true)" class="px-8 py-2.5 bg-tutu-pink text-white font-bold rounded-xl hover:bg-tutu-pink-dark shadow-lg shadow-pink-200 hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                            <i class="fa fa-check-circle"></i> Approve & Live
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderSidebar, checkAdminAuth, db } from "./common.js";
        import { collection, query, orderBy, getDocs, doc, updateDoc, deleteDoc, addDoc, limit, startAfter, getDoc, getCountFromServer, where, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const publicDataPath = `/artifacts/${appId}/public/data`;

        // --- GLOBAL VARIABLES ---
        let productsCache = [];
        let lastVisibleDoc = null;
        let isFetching = false;
        let hasMore = true;
        let selectedProduct = null;
        let currentUploadFile = null; 
        let availableCategories = new Set();
        let recognition; 
        let currentVariations = []; // ðŸ”¥ Store variations here

        // API Keys
        let GEMINI_API_KEY = null;
        let IMGBB_API_KEY = null;

        const AI_MODELS = [
            'gemini-2.0-flash', 
            'gemini-2.0-flash-exp', 
            'gemini-2.5-flash',
            'gemini-1.5-flash'
        ];

        // --- 1. MAIN INIT & AUTH LISTENER ---
        const auth = getAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("âœ… User Logged In:", user.uid);
                checkAdminAuth();
                renderSidebar('products');
                await loadSystemApiKeys();
                loadProducts(true);
                refreshStats();
            } else {
                console.warn("â›” User not logged in. Redirecting...");
                window.location.href = "login.html"; 
            }
        });

        async function loadSystemApiKeys() {
            try {
                const snap = await getDoc(doc(db, 'config', 'ai_keys'));
                if (snap.exists()) {
                    const data = snap.data();
                    GEMINI_API_KEY = data.geminiKey;
                    IMGBB_API_KEY = data.imgbbKey;
                } else {
                    Swal.fire({ icon: 'warning', title: 'Setup Required', text: 'Please configure API Keys in Settings.' });
                }
            } catch (e) {
                console.error("ðŸ”¥ Key Load Error:", e);
            }
        }

        // --- 2. IMAGE UPLOAD LOGIC (IMGBB) ---
        document.getElementById('image-upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            currentUploadFile = file;

            if (!IMGBB_API_KEY) {
                Swal.fire({ icon: 'error', title: 'Missing Key', text: 'ImgBB API Key not loaded.' });
                return;
            }

            const uploadStatus = document.getElementById('upload-status');
            const imgPreview = document.getElementById('edit-img');
            const urlInput = document.getElementById('edit-img-url');

            uploadStatus.classList.remove('hidden');
            imgPreview.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    const imageUrl = data.data.url;
                    urlInput.value = imageUrl;
                    imgPreview.src = imageUrl;
                    updateAuditScore();
                } else {
                    throw new Error(data.error.message || 'Upload failed');
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Upload Failed', text: error.message });
            } finally {
                uploadStatus.classList.add('hidden');
                imgPreview.style.opacity = '1';
                e.target.value = ''; 
            }
        });

        // --- 3. VOICE RECOGNITION ---
        window.toggleVoiceRecognition = () => {
            const micBtn = document.getElementById('mic-btn');
            const micIcon = document.getElementById('mic-icon');
            const micText = document.getElementById('mic-text');
            const voiceInput = document.getElementById('voice-input');

            if (recognition && recognition.started) {
                stopVoiceRecognition();
            } else {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Please use Google Chrome for voice features.");
                    return;
                }
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'si-LK'; 
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.started = true;

                recognition.onstart = () => {
                    micBtn.classList.add('mic-listening');
                    micIcon.className = 'fa fa-microphone animate-pulse';
                    micText.textContent = 'Listening...';
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + '. ';
                    }
                    if (finalTranscript) voiceInput.value = (voiceInput.value + ' ' + finalTranscript).trim();
                };

                recognition.onerror = (event) => { stopVoiceRecognition(); };
                recognition.onend = () => { if (recognition.started) recognition.start(); };
                recognition.start();
            }
        };

        function stopVoiceRecognition() {
            if (recognition) {
                recognition.started = false;
                recognition.stop();
                document.getElementById('mic-btn').classList.remove('mic-listening');
                document.getElementById('mic-icon').className = 'fa fa-microphone-slash';
                document.getElementById('mic-text').textContent = 'Start Mic';
            }
        }

        // --- 4. AI AUTO-FILL (WITH VARIATIONS) ---
        window.magicFixProductVision = async () => {
            if (!GEMINI_API_KEY) return Swal.fire({ icon: 'error', title: 'No AI Key', text: 'System AI Key not loaded.' });

            const btn = document.getElementById('btn-magic-fix');
            const originalText = btn.innerHTML;
            const imgUrl = document.getElementById('edit-img-url').value;
            const voiceNotes = document.getElementById('voice-input').value;

            if (!currentUploadFile && !imgUrl) {
                return Swal.fire({ icon: 'warning', title: 'Image Required', text: 'Please upload an image first.' });
            }

            btn.innerHTML = '<i class="fa fa-bolt fa-spin"></i> AI Thinking...';
            btn.disabled = true;
            document.getElementById('ai-status').classList.remove('hidden');

            try {
                let base64Image;
                if (currentUploadFile) {
                    base64Image = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(currentUploadFile);
                    });
                } else if (imgUrl) {
                    try {
                        const imageResponse = await fetch(imgUrl);
                        const blob = await imageResponse.blob();
                        base64Image = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(blob);
                        });
                    } catch (e) {
                        throw new Error("CORS Error. Please re-upload image.");
                    }
                }

                // ðŸ”¥ UPDATED PROMPT FOR VARIATIONS
                const promptText = `
                    You are a backend JSON API. 
                    Analyze this image and voice note: "${voiceNotes || ''}".
                    
                    If the voice note mentions colors, sizes, or different types, create "variations".
                    
                    Return ONLY a valid JSON object. Do NOT include markdown formatting like \`\`\`json.
                    Strict JSON Schema:
                    { 
                        "name": "Product Name (English)", 
                        "description": "Short description (max 2 sentences)", 
                        "category": "One Word Category", 
                        "price": 0,
                        "variations": [
                            { "name": "Red", "price": 1500 },
                            { "name": "Blue", "price": 1500 },
                            { "name": "Size XL", "price": 1600 }
                        ]
                    }
                `;

                let successData = null;
                let usedModel = "";

                for (const modelName of AI_MODELS) {
                    try {
                        console.log(`ðŸ¤– Attempting with model: ${modelName}...`);
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: promptText }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] 
                            })
                        });
                        const data = await response.json();
                        if (data.candidates && data.candidates[0].content) {
                            successData = data; usedModel = modelName; break;
                        }
                    } catch (e) { console.warn(e); }
                }

                if (successData) {
                    const rawText = successData.candidates[0].content.parts[0].text;
                    const jsonStr = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
                    const result = JSON.parse(jsonStr);
                    
                    document.getElementById('edit-name').value = result.name || '';
                    document.getElementById('edit-category').value = result.category || '';
                    document.getElementById('edit-desc').value = result.description || '';
                    document.getElementById('edit-price').value = result.price || 0;

                    // ðŸ”¥ HANDLE VARIATIONS
                    if (result.variations && Array.isArray(result.variations)) {
                        currentVariations = result.variations.map(v => ({
                            name: v.name,
                            price: v.price || result.price,
                            imageUrl: document.getElementById('edit-img-url').value 
                        }));
                        renderVariations();
                    }

                    Swal.fire({ icon: 'success', title: 'Auto-Filled!', text: `Details + ${currentVariations.length} variations found!`, timer: 2000 });
                } else {
                    throw new Error("AI could not process request.");
                }

            } catch (e) {
                console.error(e);
                Swal.fire({ icon: 'error', title: 'AI Failed', text: e.message });
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
                document.getElementById('ai-status').classList.add('hidden');
            }
        };

        // --- 5. VARIATION MANAGEMENT FUNCTIONS ---
        window.renderVariations = () => {
            const container = document.getElementById('variations-list');
            container.innerHTML = '';
            currentVariations.forEach((v, index) => {
                const html = `
                    <div class="flex items-center justify-between bg-white p-2 border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center gap-3">
                            <img src="${v.imageUrl || 'https://placehold.co/50'}" class="w-10 h-10 rounded-md object-cover border border-gray-100">
                            <div>
                                <p class="text-xs font-bold text-gray-800">${v.name}</p>
                                <p class="text-[10px] text-gray-500">LKR ${v.price}</p>
                            </div>
                        </div>
                        <button onclick="removeVariation(${index})" class="text-red-400 hover:text-red-600 p-2"><i class="fa fa-times-circle"></i></button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        };

        window.addManualVariation = async () => {
            const name = document.getElementById('var-name-input').value;
            const priceInput = document.getElementById('var-price-input').value;
            const fileInput = document.getElementById('var-img-input');
            const mainPrice = document.getElementById('edit-price').value;

            if (!name) return Swal.fire({ icon: 'warning', text: 'Variation Name Required' });

            let finalImgUrl = document.getElementById('edit-img-url').value; 

            if (fileInput.files[0]) {
                const btnText = document.getElementById('var-img-btn-text');
                btnText.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Uploading...';
                try {
                    const formData = new FormData();
                    formData.append('image', fileInput.files[0]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) finalImgUrl = data.data.url;
                } catch (e) { console.error(e); } 
                finally { btnText.innerHTML = '<i class="fa fa-camera"></i> Choose'; fileInput.value = ''; }
            }

            currentVariations.push({
                name: name,
                price: priceInput ? Number(priceInput) : Number(mainPrice),
                imageUrl: finalImgUrl
            });

            document.getElementById('var-name-input').value = '';
            document.getElementById('var-price-input').value = '';
            renderVariations();
        };

        window.removeVariation = (index) => {
            currentVariations.splice(index, 1);
            renderVariations();
        };

        // --- 6. CRUD OPERATIONS ---
        async function loadProducts(reset = false) {
            if (isFetching || (!hasMore && !reset)) return;
            isFetching = true;
            document.getElementById('scroll-loader').classList.remove('hidden');
            
            if (reset) {
                productsCache = []; availableCategories.clear(); lastVisibleDoc = null; hasMore = true;
                document.getElementById('products-table-body').innerHTML = '';
                document.getElementById('end-of-list').classList.add('hidden');
            }

            try {
                let q = query(collection(db, publicDataPath, 'products'), orderBy('createdAt', 'desc'), limit(20));
                if (lastVisibleDoc) q = query(collection(db, publicDataPath, 'products'), orderBy('createdAt', 'desc'), startAfter(lastVisibleDoc), limit(20));
                
                const snap = await getDocs(q);
                if (snap.empty) {
                    hasMore = false; document.getElementById('end-of-list').classList.remove('hidden');
                } else {
                    lastVisibleDoc = snap.docs[snap.docs.length - 1];
                    const newProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    productsCache = [...productsCache, ...newProducts];
                    newProducts.forEach(p => { if(p.category) availableCategories.add(p.category); });
                    updateCategoryFilter();
                    renderTable(newProducts, true);
                }
            } catch (e) { console.error(e); } 
            finally { isFetching = false; document.getElementById('scroll-loader').classList.add('hidden'); }
        }

        function renderTable(products, append = false) {
            const tbody = document.getElementById('products-table-body');
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;

            const filtered = products.filter(p => {
                let statusMatch = true;
                if (statusFilter === 'pending') statusMatch = p.isApproved == null;
                if (statusFilter === 'approved') statusMatch = p.isApproved === true;
                if (statusFilter === 'rejected') statusMatch = p.isApproved === false;
                let catMatch = categoryFilter === 'all' || p.category === categoryFilter;
                return statusMatch && catMatch;
            });

            const rows = filtered.map(p => {
                const { score } = calculateProductScore(p);
                let statusBadge = p.isApproved === true ? '<span class="bg-green-50 text-green-700 px-2 rounded-full text-xs font-bold border border-green-200">Active</span>' : 
                                  p.isApproved === false ? '<span class="bg-red-50 text-red-700 px-2 rounded-full text-xs font-bold border border-red-200">Rejected</span>' : 
                                  '<span class="bg-yellow-50 text-yellow-700 px-2 rounded-full text-xs font-bold border border-yellow-200">Pending</span>';
                let scoreClass = score >= 80 ? 'score-high' : score < 50 ? 'score-low' : 'score-mid';

                return `
                    <tr class="border-b border-gray-50 hover:bg-pink-50/20 transition group" id="row-${p.id}">
                        <td class="p-4 flex items-center gap-4">
                            <img src="${p.imageUrl || 'https://placehold.co/50'}" class="w-14 h-14 rounded-xl object-cover border border-gray-100 bg-gray-50">
                            <div><p class="font-bold text-gray-800 text-sm line-clamp-1">${p.name || 'No Name'}</p><p class="text-xs text-tutu-pink font-medium mt-0.5">${p.storeName || 'Unknown Store'}</p></div>
                        </td>
                        <td class="p-4 text-xs font-bold text-gray-500 uppercase">${p.category || '-'}</td>
                        <td class="p-4"><div class="flex items-center justify-center"><div class="score-circle ${scoreClass}">${score}</div></div></td>
                        <td class="p-4 text-center">${statusBadge}</td>
                        <td class="p-4 text-center">
                            <button onclick="openEditModal('${p.id}')" class="bg-white border text-gray-600 hover:text-tutu-pink hover:border-tutu-pink px-4 py-2 rounded-xl text-xs font-bold transition-all shadow-sm flex gap-2 mx-auto"><i class="fa fa-pencil-alt"></i> Edit</button>
                        </td>
                    </tr>`;
            }).join('');
            if (append) tbody.insertAdjacentHTML('beforeend', rows); else tbody.innerHTML = rows;
        }

        window.saveChanges = async (approve = false) => {
            const name = document.getElementById('edit-name').value;
            const price = document.getElementById('edit-price').value;
            const imageUrl = document.getElementById('edit-img-url').value;

            if(!name || !price || !imageUrl) return Swal.fire({ icon: 'warning', title: 'Missing Info', text: 'Name, Price and Image required.' });

            try {
                const newData = {
                    name, category: document.getElementById('edit-category').value,
                    price: Number(price),
                    originalPrice: Number(document.getElementById('edit-orig-price').value) || null,
                    minPrice: Number(document.getElementById('edit-min-price').value) || null,
                    description: document.getElementById('edit-desc').value,
                    imageUrl,
                    variations: currentVariations, // ðŸ”¥ SAVE VARIATIONS
                    customizationAvailable: document.getElementById('edit-custom').checked,
                    isApproved: approve ? true : document.getElementById('edit-active').checked,
                    storeName: selectedProduct ? selectedProduct.storeName : 'TUTU Store',
                    sellerUid: selectedProduct ? selectedProduct.sellerUid : auth.currentUser.uid
                };

                if (selectedProduct) {
                    await updateDoc(doc(db, publicDataPath, 'products', selectedProduct.id), newData);
                    Object.assign(selectedProduct, newData);
                    const row = document.getElementById(`row-${selectedProduct.id}`);
                    if(row) { row.querySelector('.font-bold').textContent = newData.name; row.querySelector('img').src = newData.imageUrl; }
                } else {
                    newData.createdAt = serverTimestamp();
                    const docRef = await addDoc(collection(db, publicDataPath, 'products'), newData);
                    productsCache.unshift({ id: docRef.id, ...newData });
                    renderTable(productsCache);
                }

                if(newData.category) availableCategories.add(newData.category);
                updateCategoryFilter();
                Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500 });
                if(approve) closeModal();

            } catch (e) { console.error(e); Swal.fire({ icon: 'error', title: 'Error', text: e.message }); }
        };

        function calculateProductScore(p) {
            let score = 100; let audit = [];
            if (!p.imageUrl) { score -= 40; audit.push({ text: "Missing Image", pass: false }); } else { audit.push({ text: "Image Present", pass: true }); }
            if (!p.name || p.name.length < 5) { score -= 10; audit.push({ text: "Short Name", pass: false }); } else { audit.push({ text: "Name OK", pass: true }); }
            if (!p.price || p.price <= 0) { score -= 20; audit.push({ text: "Bad Price", pass: false }); } else { audit.push({ text: "Price OK", pass: true }); }
            return { score, audit };
        }

        function updateAuditScore(p = null) {
            const { score, audit } = calculateProductScore(p || { 
                imageUrl: document.getElementById('edit-img-url').value, 
                name: document.getElementById('edit-name').value, 
                price: document.getElementById('edit-price').value 
            });
            document.getElementById('modal-score-val').textContent = `${score}/100`;
            document.getElementById('modal-score-bar').style.width = `${score}%`;
            document.getElementById('modal-score-bar').className = `h-2 rounded-full ${score >= 80 ? 'bg-green-500' : (score < 50 ? 'bg-red-500' : 'bg-yellow-500')}`;
            document.getElementById('modal-audit-list').innerHTML = audit.map(i => `<div class="flex items-center text-xs text-gray-300"><i class="fa ${i.pass ? 'fa-check text-green-500' : 'fa-times text-red-500'} w-5"></i>${i.text}</div>`).join('');
        }

        window.filterProducts = () => { document.getElementById('products-table-body').innerHTML = ''; renderTable(productsCache, true); };
        function updateCategoryFilter() {
            const select = document.getElementById('category-filter');
            let html = '<option value="all">All Categories</option>';
            Array.from(availableCategories).sort().forEach(cat => html += `<option value="${cat}">${cat}</option>`);
            select.innerHTML = html;
        }

        window.openCreateModal = () => {
            selectedProduct = null; currentUploadFile = null;
            document.getElementById('edit-modal').classList.remove('hidden');
            resetModal();
        };
        window.openEditModal = (pid) => {
            selectedProduct = productsCache.find(p => p.id === pid);
            if (!selectedProduct) return;
            currentUploadFile = null;
            document.getElementById('edit-modal').classList.remove('hidden');
            populateModal(selectedProduct);
        };
        window.closeModal = () => {
            document.getElementById('edit-modal').classList.add('hidden');
            stopVoiceRecognition();
        };

        function resetModal() {
            document.getElementById('modal-id').textContent = "NEW";
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-category').value = '';
            document.getElementById('edit-price').value = '';
            document.getElementById('edit-orig-price').value = '';
            document.getElementById('edit-min-price').value = '';
            document.getElementById('edit-desc').value = '';
            document.getElementById('edit-img-url').value = '';
            document.getElementById('edit-img').src = 'https://placehold.co/400?text=Click+to+Upload';
            document.getElementById('voice-input').value = '';
            currentVariations = []; // ðŸ”¥ Clear Vars
            renderVariations();
            updateAuditScore();
        }
        function populateModal(p) {
            document.getElementById('modal-id').textContent = p.id;
            document.getElementById('edit-img').src = p.imageUrl;
            document.getElementById('edit-img-url').value = p.imageUrl;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-category').value = p.category;
            document.getElementById('edit-price').value = p.price;
            document.getElementById('edit-orig-price').value = p.originalPrice;
            document.getElementById('edit-min-price').value = p.minPrice;
            document.getElementById('edit-desc').value = p.description;
            currentVariations = p.variations || []; // ðŸ”¥ Load Vars
            renderVariations();
            updateAuditScore(p);
        }

        window.refreshStats = async () => {
            try {
                const coll = collection(db, publicDataPath, 'products');
                const pendingSnap = await getCountFromServer(query(coll, where("isApproved", "==", null)));
                const liveSnap = await getCountFromServer(query(coll, where("isApproved", "==", true)));
                document.getElementById('stat-pending').textContent = pendingSnap.data().count;
                document.getElementById('stat-live').textContent = liveSnap.data().count;
            } catch (e) {}
        };

        window.deleteProduct = async () => {
            if(!selectedProduct || !confirm("Delete?")) return;
            await deleteDoc(doc(db, publicDataPath, 'products', selectedProduct.id));
            document.getElementById(`row-${selectedProduct.id}`).remove();
            closeModal();
        };
        window.updateProductStatus = async (status) => {
            if(!selectedProduct) return;
            await updateDoc(doc(db, publicDataPath, 'products', selectedProduct.id), { isApproved: status === 'approved' ? true : false });
            closeModal(); loadProducts(true);
        };
        window.resetAndReload = () => loadProducts(true);
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderTable(productsCache.filter(p => p.name.toLowerCase().includes(term)));
        });

        window.addEventListener('scroll', () => { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) loadProducts(); });
        
        // Expose functions to global scope
        window.renderVariations = renderVariations;
        window.addManualVariation = addManualVariation;
        window.removeVariation = removeVariation;
    </script>
</body>
</html>