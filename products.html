<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Manager Pro - TUTU Admin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'tutu-pink': { DEFAULT: '#db2777', dark: '#be185d', light: '#fbcfe8' },
                        'ai-purple': '#8b5cf6',
                        'mudalali-green': '#3a6a4a'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-link.active { @apply bg-tutu-pink text-white shadow-md; }
        .magic-btn {
            background: linear-gradient(45deg, #db2777, #a855f7, #ec4899);
            background-size: 200% 200%;
            animation: gradient-xy 3s ease infinite;
        }
        @keyframes gradient-xy { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-thumb { background-color: #fbcfe8; border-radius: 10px; }
        
        .score-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #eee; }
        .score-high { border-color: #22c55e; color: #15803d; background: #f0fdf4; }
        .score-mid { border-color: #eab308; color: #a16207; background: #fefce8; }
        .score-low { border-color: #ef4444; color: #b91c1c; background: #fef2f2; }
        
        .mic-listening { animation: pulse-red 1.5s infinite; background-color: #fee2e2 !important; color: #dc2626 !important; border-color: #dc2626 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        
        .img-grid-item { transition: all 0.3s ease; border: 2px solid transparent; cursor: pointer; }
        .img-grid-item.active { border-color: #db2777; transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="sidebar-container"></div>

    <main class="md:ml-64 p-8 mt-12 md:mt-0">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Product Command Center ðŸš€</h1>
                <p class="text-sm text-gray-500 font-medium">Manage Inventory with Multi-Model AI Analysis</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openCreateModal()" class="bg-tutu-pink text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-tutu-pink-dark transition-all transform hover:scale-105 flex items-center gap-2">
                    <i class="fa fa-plus-circle"></i> Add Product
                </button>
                <button onclick="loadProducts(true)" class="bg-white border border-gray-200 text-gray-600 px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-50 transition shadow-sm">
                    <i class="fa fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-yellow-500">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Pending Approval</p>
                <h2 class="text-3xl font-bold text-yellow-600 mt-1" id="stat-pending">...</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-mudalali-green">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Live Listings</p>
                <h2 class="text-3xl font-bold text-mudalali-green mt-1" id="stat-live">...</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-red-500">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Rejected</p>
                <h2 class="text-3xl font-bold text-red-600 mt-1" id="stat-rejected">...</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-tutu-pink">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Categories</p>
                <h2 class="text-3xl font-bold text-tutu-pink mt-1" id="stat-cats">...</h2>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b bg-gray-50/50 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-96">
                    <i class="fa fa-search absolute left-4 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-tutu-pink outline-none text-sm" placeholder="Search by name or category...">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="category-filter" onchange="loadProducts(true)" class="p-2 border rounded-xl bg-white text-xs font-bold outline-none flex-grow">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="status-filter" onchange="loadProducts(true)" class="p-2 border rounded-xl bg-white text-xs font-bold outline-none flex-grow">
                        <option value="all">All Status</option>
                        <option value="pending">Pending Approval</option>
                        <option value="approved">Live</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto min-h-[400px]">
                <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-white text-gray-500 uppercase text-[10px] font-black border-b sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-5">Product Info</th>
                            <th class="p-5">Category / Hierarchy</th>
                            <th class="p-5 text-center">Quality Score</th>
                            <th class="p-5 text-center">Listing Status</th>
                            <th class="p-5 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="divide-y divide-gray-50">
                        <tr><td colspan="5" class="p-10 text-center text-gray-400"><i class="fa fa-spinner fa-spin text-2xl"></i></td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="scroll-loader" class="p-4 text-center hidden"><i class="fa fa-circle-notch fa-spin text-tutu-pink"></i></div>
        </div>
    </main>

    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-6xl h-[95vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row transform transition-all scale-100">
            
            <div class="w-full md:w-1/3 bg-gray-950 p-6 flex flex-col overflow-y-auto modal-scroll border-r border-gray-800">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2"><i class="fa fa-images text-tutu-pink"></i> Product Gallery</h3>
                
                <div class="relative group aspect-square bg-gray-900 rounded-2xl overflow-hidden border-2 border-dashed border-gray-800 mb-4 flex items-center justify-center cursor-pointer hover:border-tutu-pink transition-all" onclick="document.getElementById('image-upload-input').click()">
                    <img id="edit-img-main" src="https://placehold.co/500?text=Upload+Images" class="w-full h-full object-contain">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center text-white transition-opacity">
                        <i class="fa fa-plus-circle text-4xl mb-2"></i>
                        <span class="text-xs font-bold uppercase">Add Photos</span>
                    </div>
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                </div>

                <div id="image-gallery-container" class="grid grid-cols-4 gap-2 mb-6"></div>

                <div class="mt-auto bg-gray-900 border border-gray-800 p-5 rounded-2xl">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-500 text-[10px] font-black uppercase tracking-widest">Listing Score</span>
                        <span id="modal-score-val" class="text-xl font-bold text-white">0/100</span>
                    </div>
                    <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden mb-4">
                        <div id="modal-score-bar" class="h-full bg-tutu-pink transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <div id="modal-audit-list" class="space-y-1.5"></div>
                </div>
            </div>

            <div class="w-full md:w-2/3 flex flex-col bg-white overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white shadow-sm z-10">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight" id="modal-title">Product Details</h2>
                        <p class="text-[10px] text-gray-400 font-mono mt-0.5">UID: <span id="modal-id">...</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="magicFixProductVision()" id="btn-magic-fix" class="magic-btn text-white px-5 py-2.5 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all flex items-center gap-2 text-xs">
                            <i class="fa fa-wand-magic-sparkles"></i> AI AUTO-FILL
                        </button>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-3xl">&times;</button>
                    </div>
                </div>

                <div class="p-8 overflow-y-auto modal-scroll flex-grow space-y-8">
                    
                    <div class="bg-pink-50 p-5 rounded-2xl border border-pink-100 relative overflow-hidden">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-black text-tutu-pink uppercase tracking-widest flex items-center gap-2"><i class="fa fa-microphone-alt"></i> Voice Note (Describe Product)</label>
                            <button id="mic-btn" onclick="toggleVoiceRecognition()" class="bg-white border border-pink-200 px-3 py-1.5 rounded-full text-[10px] font-bold text-gray-600 hover:text-tutu-pink transition-all flex items-center gap-2">
                                <i class="fa fa-microphone-slash" id="mic-icon"></i> <span id="mic-text">Start Recording</span>
                            </button>
                        </div>
                        <textarea id="voice-input" rows="2" class="w-full bg-white/50 border border-pink-100 rounded-xl p-3 text-sm focus:ring-2 focus:ring-tutu-pink outline-none resize-none" placeholder="e.g. 'Red floral dress, price 2500, silk material'"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Product Title</label>
                            <input type="text" id="edit-name" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-tutu-pink outline-none font-bold text-gray-800 transition-all">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Main Category</label>
                            <select id="edit-category-main" onchange="loadSubCategories()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none font-bold text-gray-700"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Sub Category</label>
                            <select id="edit-category-sub" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none font-bold text-gray-700 disabled:opacity-50" disabled></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-3xl border border-gray-100">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Retail Price (LKR)</label>
                            <input type="number" id="edit-price" class="w-full p-4 bg-white border border-gray-100 rounded-2xl font-mono font-bold text-tutu-pink outline-none focus:ring-2 focus:ring-tutu-pink">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Resell Price</label>
                            <input type="number" id="edit-resell-price" class="w-full p-4 bg-white border border-gray-100 rounded-2xl font-mono font-bold text-blue-600 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Original</label>
                            <input type="number" id="edit-orig-price" class="w-full p-4 bg-white border border-gray-100 rounded-2xl font-mono text-gray-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Min (Hidden)</label>
                            <input type="number" id="edit-min-price" class="w-full p-4 bg-red-50 border border-red-100 rounded-2xl font-mono text-red-600 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-gray-50 rounded-3xl border border-gray-100 flex gap-4 items-end">
                            <div class="flex-grow">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Weight (KG)</label>
                                <div class="relative">
                                    <input type="number" step="0.1" id="edit-weight" oninput="calculateDelivery()" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none font-bold text-gray-800 focus:ring-2 focus:ring-tutu-pink transition-all" placeholder="0.0">
                                    <span class="absolute right-4 top-4 text-gray-300 font-bold text-xs">KG</span>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Ship Cost (LKR)</label>
                                <div class="relative">
                                    <input type="number" id="edit-delivery-price" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none font-bold text-tutu-pink focus:ring-2 focus:ring-tutu-pink transition-all" placeholder="0">
                                    <span class="absolute right-4 top-4 text-gray-300 font-bold text-xs">Rs.</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 rounded-3xl border border-gray-100 space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest">Product Variations (Nested)</label>
                                <span class="text-[9px] bg-tutu-pink/10 text-tutu-pink px-2 py-1 rounded-md font-bold">Price per Option</span>
                            </div>

                            <div class="flex gap-2">
                                <input type="text" id="main-var-input" class="flex-1 p-3 border border-gray-100 rounded-2xl text-xs outline-none focus:ring-2 focus:ring-tutu-pink shadow-sm" placeholder="Group Name (e.g. Size)">
                                <button onclick="addMainVariation()" class="bg-gray-800 text-white px-5 py-3 rounded-2xl text-[10px] font-bold hover:bg-black transition-all shadow-md active:scale-95">
                                    + ADD GROUP
                                </button>
                            </div>

                            <div id="nested-variations-container" class="space-y-3 max-h-80 overflow-y-auto pr-2 modal-scroll">
                                <div class="text-center py-4 border-2 border-dashed border-gray-200 rounded-2xl">
                                    <p class="text-[10px] text-gray-400 font-medium">No variations added yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Description</label>
                        <textarea id="edit-desc" rows="4" class="w-full p-5 bg-gray-50 border border-gray-100 rounded-3xl text-sm leading-relaxed outline-none focus:ring-2 focus:ring-tutu-pink transition-all" placeholder="Craft a compelling story..."></textarea>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-100 bg-white flex justify-between items-center rounded-br-3xl shadow-lg">
                    <button onclick="deleteProduct()" class="text-red-500 font-bold text-xs flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-red-50 transition-all">
                        <i class="fa fa-trash"></i> DELETE
                    </button>
                    <div class="flex gap-2">
                        <button onclick="saveChanges(false)" class="px-6 py-3 bg-gray-100 text-gray-600 font-bold rounded-2xl hover:bg-gray-200 transition-all text-xs">SAVE DRAFT</button>
                        <button onclick="saveChanges(true)" class="px-8 py-3 bg-tutu-pink text-white font-black rounded-2xl shadow-xl shadow-pink-100 hover:scale-105 transition-all text-xs tracking-widest uppercase">Approve & Live</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderSidebar, checkAdminAuth, db, formatLKR, showToast } from "./common.js";
        import { 
            collection, query, orderBy, getDocs, doc, updateDoc, deleteDoc, 
            addDoc, limit, startAfter, getDoc, getCountFromServer, where, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        checkAdminAuth();
        renderSidebar('products');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const publicDataPath = `/artifacts/${appId}/public/data`;
        
        // --- GLOBAL STATE ---
        let productsCache = [];
        let mainCategories = [];
        let subCategories = [];
        let currentProductImages = [];
        window.currentVariations = []; 
        let selectedProduct = null;
        let recognition;
        let lastVisibleDoc = null;
        let isFetching = false;
        
        let IMGBB_API_KEY = "";
        let GEMINI_API_KEY = "";

        // --- INIT ---
      async function init() {
    await loadApiKeys();
    await fetchCategories();
    await loadProducts(true);
    refreshStats();
    setupInfiniteScroll(); // <--- Me line eka add karanna
}

        async function loadApiKeys() {
            const snap = await getDoc(doc(db, 'config', 'ai_keys'));
            if (snap.exists()) {
                IMGBB_API_KEY = snap.data().imgbbKey;
                GEMINI_API_KEY = snap.data().geminiKey;
            }
        }

        // --- UPDATED VARIATIONS LOGIC WITH PRICE ---
        window.addMainVariation = () => {
            const input = document.getElementById('main-var-input');
            const name = input?.value.trim();
            if (name) {
                window.currentVariations.push({ name: name, options: [] });
                input.value = '';
                renderVariations();
            }
        };

        window.addSubVariation = (index) => {
            const nameInput = document.getElementById(`sub-input-${index}`);
            const priceInput = document.getElementById(`sub-price-input-${index}`);
            const name = nameInput?.value.trim();
            const price = parseFloat(priceInput?.value) || 0;

            if (name) {
                window.currentVariations[index].options.push({ name: name, price: price });
                nameInput.value = '';
                priceInput.value = '';
                renderVariations();
            }
        };

        window.removeMainVariation = (index) => {
            window.currentVariations.splice(index, 1);
            renderVariations();
        };

        window.removeSubVariation = (mainIndex, subIndex) => {
            window.currentVariations[mainIndex].options.splice(subIndex, 1);
            renderVariations();
        };

        function renderVariations() {
            const container = document.getElementById('nested-variations-container');
            if (!container) return;

            if (window.currentVariations.length === 0) {
                container.innerHTML = `<div class="text-center py-4 border-2 border-dashed border-gray-200 rounded-2xl">
                    <p class="text-[10px] text-gray-400 font-medium">No variations added yet.</p>
                </div>`;
                return;
            }

            container.innerHTML = window.currentVariations.map((group, i) => `
                <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm space-y-3 mb-2">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black text-tutu-pink uppercase tracking-tighter">${group.name}</span>
                        <button onclick="removeMainVariation(${i})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa fa-trash"></i></button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${group.options.map((opt, j) => `
                            <span class="bg-gray-100 text-[10px] font-bold px-3 py-1 rounded-full flex items-center gap-2 border border-gray-200">
                                ${opt.name} <span class="text-tutu-pink ml-1">Rs.${opt.price}</span>
                                <i class="fa fa-times cursor-pointer hover:text-red-500" onclick="removeSubVariation(${i}, ${j})"></i>
                            </span>
                        `).join('')}
                    </div>
                    <div class="flex gap-1">
                        <input type="text" id="sub-input-${i}" class="flex-[2] p-2 border rounded-xl text-[10px] outline-none focus:ring-1 focus:ring-tutu-pink" placeholder="Option (e.g. Red)">
                        <input type="number" id="sub-price-input-${i}" class="flex-1 p-2 border rounded-xl text-[10px] outline-none focus:ring-1 focus:ring-tutu-pink" placeholder="Price">
                        <button onclick="addSubVariation(${i})" class="bg-tutu-pink text-white px-3 py-1 rounded-xl text-[10px] font-bold">ADD</button>
                    </div>
                </div>
            `).join('');
            updateAuditScoreUI();
        }

      // --- UPDATED PRODUCT LOADING FOR INFINITE SCROLL ---
async function loadProducts(reset = false) {
    if (isFetching) return;
    isFetching = true;

    const tbody = document.getElementById('products-table-body');
    const loader = document.getElementById('scroll-loader');

    // Reset wenna oni nam table eka clear karala pagination pointer eka null karanawa
    if (reset) {
        tbody.innerHTML = '';
        productsCache = [];
        lastVisibleDoc = null;
        loader?.classList.remove('hidden'); // Reset ekedi loader eka pennanna
    }

    try {
        let constraints = [orderBy('createdAt', 'desc'), limit(20)];
        const catFilter = document.getElementById('category-filter').value;
        const statFilter = document.getElementById('status-filter').value;

        // Filters apply kirima
        if (catFilter !== 'all') constraints.unshift(where('category', '==', catFilter));
        if (statFilter !== 'all') {
            if (statFilter === 'pending') constraints.unshift(where('isApproved', '==', null));
            else constraints.unshift(where('isApproved', '==', statFilter === 'approved'));
        }

        // Pagination: Anthimata hambuna document eken passe ewa ganna
        if (lastVisibleDoc && !reset) {
            constraints.push(startAfter(lastVisibleDoc));
        }

        const q = query(collection(db, publicDataPath, 'products'), ...constraints);
        const snap = await getDocs(q);

        if (snap.empty) {
            if (reset) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-20 text-center text-gray-400">No products found.</td></tr>';
            }
            // Thawa items nethnam loader eka hide karanawa
            loader?.classList.add('hidden');
            lastVisibleDoc = null; 
        } else {
            // Anthima document eka mathaka thiyanawa thawa load karanna
            lastVisibleDoc = snap.docs[snap.docs.length - 1];
            const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            productsCache = [...productsCache, ...items];
            
            renderRows(items);

            // Fetch una items gana limit ekata (20) wada adu nam kiyanne thawa items na kiyana eka
            if (snap.docs.length < 20) {
                loader?.classList.add('hidden');
                lastVisibleDoc = null; // Infinite scroll eka trigger wena eka meken nawathinawa
            } else {
                loader?.classList.remove('hidden');
            }
        }
    } catch (e) { 
        console.error("Fetch Error:", e); 
        showToast('Error loading products', 'error');
    } finally { 
        isFetching = false; 
    }
}

        function renderRows(items) {
            const tbody = document.getElementById('products-table-body');
            items.forEach(p => {
                const img = p.images?.[0] || p.imageUrl || 'https://placehold.co/100';
                const score = calculateAuditScore(p);
                const status = p.isApproved === true ? 'Live' : (p.isApproved === false ? 'Rejected' : 'Pending');
                const row = `<tr class="hover:bg-pink-50/10 transition group">
                        <td class="p-5 flex items-center gap-4">
                            <img src="${img}" class="w-12 h-12 rounded-xl object-cover border shadow-sm">
                            <div class="overflow-hidden">
                                <p class="font-bold text-gray-800 truncate w-48">${p.name || 'Unnamed'}</p>
                                <p class="text-[10px] font-mono text-gray-400 mt-0.5">LKR ${p.price?.toLocaleString() || 0}</p>
                            </div>
                        </td>
                        <td class="p-5">
                            <p class="text-[10px] font-black text-gray-700 uppercase tracking-tighter">${p.category || 'N/A'}</p>
                            <p class="text-[9px] text-gray-400 font-bold">${p.subCategory || '-'}</p>
                        </td>
                        <td class="p-5 flex justify-center">
                            <div class="score-circle ${score >= 80 ? 'score-high' : (score < 50 ? 'score-low' : 'score-mid')}">${score}</div>
                        </td>
                        <td class="p-5 text-center">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${status === 'Live' ? 'bg-green-100 text-green-700' : (status === 'Rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700')}">${status}</span>
                        </td>
                        <td class="p-5 text-center">
                            <button onclick="openEditModal('${p.id}')" class="bg-white border-2 border-gray-100 text-tutu-pink font-black text-[10px] px-4 py-2 rounded-xl hover:bg-pink-50 transition-all uppercase">Manage</button>
                        </td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        window.openEditModal = async (id) => {
            try {
                showToast('Loading product details...', 'info');
                const snap = await getDoc(doc(db, publicDataPath, 'products', id));
                if (!snap.exists()) return showToast('Product not found!', 'error');
                
                selectedProduct = { id: snap.id, ...snap.data() };
                
                document.getElementById('modal-id').innerText = id;
                document.getElementById('edit-name').value = selectedProduct.name || '';
                document.getElementById('edit-price').value = selectedProduct.price || 0;
                document.getElementById('edit-resell-price').value = selectedProduct.resellPrice || 0;
                document.getElementById('edit-orig-price').value = selectedProduct.originalPrice || 0;
                document.getElementById('edit-min-price').value = selectedProduct.minPrice || 0;
                document.getElementById('edit-desc').value = selectedProduct.description || '';
                document.getElementById('edit-weight').value = selectedProduct.weight || 0;
                document.getElementById('edit-delivery-price').value = selectedProduct.deliveryPrice || 0;
                
                document.getElementById('edit-category-main').value = selectedProduct.category || '';
                loadSubCategories(selectedProduct.subCategory);

                currentProductImages = selectedProduct.images || (selectedProduct.imageUrl ? [selectedProduct.imageUrl] : []);
                window.currentVariations = Array.isArray(selectedProduct.variations) ? selectedProduct.variations : [];
                
                renderGallery();
                renderVariations();
                updateAuditScoreUI();
                
                document.getElementById('edit-modal').classList.remove('hidden');
            } catch (e) { console.error(e); showToast('Error loading product', 'error'); }
        };

        window.openCreateModal = () => {
            selectedProduct = null;
            document.getElementById('modal-id').innerText = 'NEW_ITEM';
            document.getElementById('edit-name').value = '';
            document.getElementById('edit-price').value = '';
            document.getElementById('edit-desc').value = '';
            document.getElementById('voice-input').value = '';
            currentProductImages = [];
            window.currentVariations = [];
            document.getElementById('edit-img-main').src = 'https://placehold.co/500?text=Upload+Images';
            renderGallery();
            renderVariations();
            updateAuditScoreUI();
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveChanges = async (isLive) => {
            const data = {
                name: document.getElementById('edit-name').value,
                category: document.getElementById('edit-category-main').value,
                subCategory: document.getElementById('edit-category-sub').value,
                price: Number(document.getElementById('edit-price').value),
                resellPrice: Number(document.getElementById('edit-resell-price').value) || 0,
                originalPrice: Number(document.getElementById('edit-orig-price').value) || 0,
                minPrice: Number(document.getElementById('edit-min-price').value) || 0,
                weight: Number(document.getElementById('edit-weight').value) || 0,
                deliveryPrice: Number(document.getElementById('edit-delivery-price').value) || 0,
                description: document.getElementById('edit-desc').value,
                images: currentProductImages,
                variations: window.currentVariations,
                isApproved: isLive ? true : (selectedProduct ? selectedProduct.isApproved : null),
                updatedAt: serverTimestamp()
            };

            if (!data.name || !data.price) return showToast('Name & Price Required', 'warning');

            try {
                if (selectedProduct) {
                    await updateDoc(doc(db, publicDataPath, 'products', selectedProduct.id), data);
                } else {
                    await addDoc(collection(db, publicDataPath, 'products'), { ...data, createdAt: serverTimestamp() });
                }
                showToast('Product Saved!', 'success');
                window.closeModal();
                loadProducts(true);
                refreshStats();
            } catch (err) { console.error(err); showToast('Save Failed', 'error'); }
        };

        async function fetchCategories() {
            const snap = await getDocs(collection(db, publicDataPath, 'categories'));
            const all = snap.docs.map(d => ({id: d.id, ...d.data()}));
            mainCategories = all.filter(c => !c.parentId);
            subCategories = all.filter(c => c.parentId);
            document.getElementById('category-filter').innerHTML = '<option value="all">All Categories</option>' + mainCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            document.getElementById('edit-category-main').innerHTML = '<option value="" disabled selected>Main Category</option>' + mainCategories.map(c => `<option value="${c.name}" data-id="${c.id}">${c.name}</option>`).join('');
        }

        window.loadSubCategories = (currentSub = null) => {
            const mainSel = document.getElementById('edit-category-main');
            const subSel = document.getElementById('edit-category-sub');
            const mainId = mainSel.options[mainSel.selectedIndex]?.dataset.id;
            subSel.innerHTML = '<option value="" disabled selected>Sub Category</option>';
            if(!mainId) { subSel.disabled = true; return; }
            const filtered = subCategories.filter(s => s.parentId === mainId);
            subSel.disabled = filtered.length === 0;
            subSel.innerHTML += filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            if(currentSub) subSel.value = currentSub;
        };

        document.getElementById('image-upload-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!IMGBB_API_KEY || files.length === 0) return;
            showToast('Uploading...', 'info');
            for (const file of files) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) { currentProductImages.push(data.data.url); renderGallery(); }
                } catch (err) { console.error(err); }
            }
        });

        function renderGallery() {
            const container = document.getElementById('image-gallery-container');
            const mainImg = document.getElementById('edit-img-main');
            container.innerHTML = currentProductImages.map((url, i) => `
                <div class="relative group img-grid-item aspect-square rounded-xl overflow-hidden ${mainImg.src === url ? 'active' : ''}">
                    <img src="${url}" class="w-full h-full object-cover" onclick="setMainImg('${url}')">
                    <button onclick="removeImg(${i})" class="absolute top-1 right-1 bg-red-600 text-white w-5 h-5 rounded-lg text-[10px] opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
                </div>`).join('');
            if(currentProductImages.length > 0 && mainImg.src.includes('placehold')) mainImg.src = currentProductImages[0];
        }

        window.setMainImg = (url) => { document.getElementById('edit-img-main').src = url; renderGallery(); };
        window.removeImg = (i) => { currentProductImages.splice(i, 1); renderGallery(); updateAuditScoreUI(); };

        window.magicFixProductVision = async () => {
            if (!GEMINI_API_KEY || currentProductImages.length === 0) return showToast('Upload an image first!', 'warning');
            const btn = document.getElementById('btn-magic-fix');
            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analyzing...';
            try {
                const blob = await fetch(currentProductImages[0]).then(r => r.blob());
                const base64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); });
                const prompt = `Analyze product image and notes: "${document.getElementById('voice-input').value}". Return JSON only: {"name": "...", "price": 0, "desc": "...", "category": "..."}`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                const data = await res.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text.match(/\{.*\}/s)[0]);
                document.getElementById('edit-name').value = json.name;
                document.getElementById('edit-price').value = json.price;
                document.getElementById('edit-desc').value = json.desc;
                showToast('AI Auto-fill Done!', 'success');
                updateAuditScoreUI();
            } catch (e) { showToast('AI Error', 'error'); } finally { btn.disabled = false; btn.innerHTML = '<i class="fa fa-wand-magic-sparkles"></i> AI AUTO-FILL'; }
        };

        function calculateAuditScore(p) {
            let score = 100;
            if (!p.images || p.images.length === 0) score -= 40;
            if (!p.name || p.name.length < 10) score -= 20;
            if (!p.description || p.description.length < 30) score -= 20;
            if (!p.price || p.price <= 0) score -= 20;
            return Math.max(0, score);
        }

        function updateAuditScoreUI() {
            const score = calculateAuditScore({
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-desc').value,
                price: Number(document.getElementById('edit-price').value),
                images: currentProductImages
            });
            document.getElementById('modal-score-val').innerText = `${score}/100`;
            document.getElementById('modal-score-bar').style.width = `${score}%`;
        }

        window.deleteProduct = async () => {
            if (!selectedProduct || !confirm("Erase this product forever?")) return;
            await deleteDoc(doc(db, publicDataPath, 'products', selectedProduct.id));
            window.closeModal();
            loadProducts(true);
            refreshStats();
        };

        window.toggleVoiceRecognition = () => {
            if (recognition && recognition.active) { recognition.stop(); return; }
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new Speech();
            recognition.lang = 'si-LK';
            recognition.continuous = true;
            recognition.onstart = () => { 
                document.getElementById('mic-btn').classList.add('mic-listening');
                document.getElementById('mic-text').innerText = 'LISTENING...';
            };
            recognition.onresult = (e) => { document.getElementById('voice-input').value += ' ' + e.results[e.results.length-1][0].transcript; };
            recognition.onend = () => {
                document.getElementById('mic-btn').classList.remove('mic-listening');
                document.getElementById('mic-text').innerText = 'Start Recording';
            };
            recognition.start();
        };

        async function refreshStats() {
            const coll = collection(db, publicDataPath, 'products');
            const [p, l, r] = await Promise.all([
                getCountFromServer(query(coll, where("isApproved", "==", null))),
                getCountFromServer(query(coll, where("isApproved", "==", true))),
                getCountFromServer(query(coll, where("isApproved", "==", false)))
            ]);
            document.getElementById('stat-pending').innerText = p.data().count;
            document.getElementById('stat-live').innerText = l.data().count;
            document.getElementById('stat-rejected').innerText = r.data().count;
        }

        window.calculateDelivery = () => {
            const w = parseFloat(document.getElementById('edit-weight').value) || 0;
            const cost = w <= 0.5 ? 350 : (350 + Math.ceil((w - 0.5) * 2) * 100);
            document.getElementById('edit-delivery-price').value = cost;
        };

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');

        const setupInfiniteScroll = () => {
    const loader = document.getElementById('scroll-loader');
    if (!loader) return;

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !isFetching && lastVisibleDoc) {
            loadProducts(false); // Thawa items load karanna
        }
    }, { threshold: 0.5 });

    observer.observe(loader);
};
        init();
    </script>
</body>
</html>