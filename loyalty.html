<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mudalali Command Center v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            light: '#f1f5f9',
                            primary: '#6366f1', // Indigo
                            accent: '#10b981',  // Emerald
                            glass: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        
        /* Glassmorphism Classes */
        .glass-panel {
            @apply bg-white/80 backdrop-blur-md border border-white/50 shadow-glass rounded-2xl transition-all duration-300;
        }
        .glass-panel:hover {
            @apply border-indigo-100 shadow-lg;
        }
        
        /* Inputs */
        .input-std {
            @apply w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all;
        }
        
        /* Scrollbars */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        
        .tab-btn {
            @apply px-4 py-2 text-sm font-bold text-slate-500 rounded-lg transition-all flex items-center gap-2;
        }
        .tab-btn.active {
            @apply bg-indigo-600 text-white shadow-md shadow-indigo-200;
        }
        .tab-btn:not(.active):hover {
            @apply bg-slate-200 text-slate-700;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="sidebar-container"></div>

    <main class="md:ml-64 p-4 lg:p-8 min-h-screen transition-all duration-300">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 animate-slide-up">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Mudalali Control <span class="text-indigo-600">.</span></h1>
                <p class="text-slate-400 text-sm font-medium mt-1">Manage Loyalty, Missions & Analytics</p>
            </div>
            
            <div class="flex items-center gap-3 bg-white p-1.5 rounded-xl shadow-sm border border-slate-200">
                <button onclick="switchTab('command')" id="btn-command" class="tab-btn active"><i class="fa fa-rocket"></i> Command</button>
                <button onclick="switchTab('analytics')" id="btn-analytics" class="tab-btn"><i class="fa fa-chart-line"></i> Insights</button>
                <button onclick="switchTab('notify')" id="btn-notify" class="tab-btn"><i class="fa fa-bell"></i> Broadcast</button>
            </div>

            <button onclick="saveConfig()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2 group text-sm">
                <i class="fa fa-save group-hover:animate-pulse"></i> Save Config
            </button>
        </header>

        <div id="view-command" class="animate-slide-up space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-pink-500/10 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="flex justify-between items-start mb-2">
                        <div class="p-2 bg-pink-100 text-pink-600 rounded-lg"><i class="fa fa-bolt"></i></div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="flash-boost" class="sr-only peer">
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-500"></div>
                        </label>
                    </div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Happy Hour</p>
                    <p class="text-lg font-black text-slate-700">2x Points</p>
                </div>

                <div class="glass-panel p-4 group hover:border-emerald-300">
                    <div class="flex justify-between items-start mb-2">
                        <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg"><i class="fa fa-coins"></i></div>
                        <span class="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-2 py-1 rounded">Global</span>
                    </div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Earn Rate</p>
                    <div class="flex items-center gap-1">
                        <input type="number" id="rate-earn" class="w-16 bg-transparent font-black text-xl text-slate-700 outline-none border-b border-dashed border-slate-300 focus:border-emerald-500 p-0" value="1">
                        <span class="text-xs font-bold text-slate-400">pts / 100</span>
                    </div>
                </div>

                <div class="glass-panel p-4 group hover:border-orange-300">
                    <div class="flex justify-between items-start mb-2">
                        <div class="p-2 bg-orange-100 text-orange-600 rounded-lg"><i class="fa fa-hourglass-half"></i></div>
                    </div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Coin Expiry</p>
                    <div class="flex items-center gap-1">
                        <input type="number" id="limit-expiry" class="w-16 bg-transparent font-black text-xl text-slate-700 outline-none border-b border-dashed border-slate-300 focus:border-orange-500 p-0" value="90">
                        <span class="text-xs font-bold text-slate-400">Days</span>
                    </div>
                </div>

                <div class="glass-panel p-4 group hover:border-blue-300">
                    <div class="flex justify-between items-start mb-2">
                        <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i class="fa fa-percent"></i></div>
                    </div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Max Redeem</p>
                    <div class="flex items-center gap-1">
                        <input type="number" id="limit-percent" class="w-16 bg-transparent font-black text-xl text-slate-700 outline-none border-b border-dashed border-slate-300 focus:border-blue-500 p-0" value="50">
                        <span class="text-xs font-bold text-slate-400">% Bill</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="glass-panel p-5 border-t-4 border-t-slate-400">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-slate-600"><i class="fa fa-medal mr-2 text-slate-400"></i>Silver</h3><span class="text-[10px] bg-slate-100 px-2 py-1 rounded font-bold">Lvl 1</span></div>
                        <div class="space-y-2">
                            <div><label class="text-[9px] uppercase font-bold text-slate-400">Min Points</label><input type="number" id="tier-silver-min" class="input-std" value="0"></div>
                            <div><label class="text-[9px] uppercase font-bold text-slate-400">Multiplier</label><input type="number" id="tier-silver-mult" class="input-std" value="1.0"></div>
                        </div>
                    </div>
                    <div class="glass-panel p-5 border-t-4 border-t-yellow-400 bg-yellow-50/30">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-yellow-700"><i class="fa fa-crown mr-2 text-yellow-500"></i>Gold</h3><span class="text-[10px] bg-white px-2 py-1 rounded font-bold border border-yellow-200">Lvl 2</span></div>
                        <div class="space-y-2">
                            <div><label class="text-[9px] uppercase font-bold text-yellow-600/70">Min Points</label><input type="number" id="tier-gold-min" class="input-std border-yellow-200 focus:border-yellow-500" value="50000"></div>
                            <div><label class="text-[9px] uppercase font-bold text-yellow-600/70">Multiplier</label><input type="number" id="tier-gold-mult" class="input-std border-yellow-200 focus:border-yellow-500" value="1.2"></div>
                        </div>
                    </div>
                    <div class="glass-panel p-5 border-t-4 border-t-indigo-500 bg-indigo-50/30">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-indigo-800"><i class="fa fa-gem mr-2 text-indigo-500"></i>Platinum</h3><span class="text-[10px] bg-white px-2 py-1 rounded font-bold border border-indigo-200">Lvl 3</span></div>
                        <div class="space-y-2">
                            <div><label class="text-[9px] uppercase font-bold text-indigo-600/70">Min Points</label><input type="number" id="tier-plat-min" class="input-std border-indigo-200 focus:border-indigo-500" value="150000"></div>
                            <div><label class="text-[9px] uppercase font-bold text-indigo-600/70">Multiplier</label><input type="number" id="tier-plat-mult" class="input-std border-indigo-200 focus:border-indigo-500" value="1.5"></div>
                        </div>
                    </div>
                </div>
                
                <div class="lg:col-span-1 glass-panel p-5 flex flex-col justify-center gap-4 relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-purple-200 rounded-full opacity-50 blur-xl"></div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-lg shadow-sm"><i class="fa fa-calendar-check"></i></div>
                        <div><h4 class="font-bold text-slate-700">Daily Login</h4><p class="text-[10px] text-slate-400">Engagement Config</p></div>
                        <input type="checkbox" id="daily-active" class="accent-purple-600 w-5 h-5 cursor-pointer ml-auto" checked>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <div><label class="text-[9px] font-bold text-slate-500">Base Reward</label><input type="number" id="daily-amount" class="input-std text-center" value="5"></div>
                        <div><label class="text-[9px] font-bold text-slate-500">7-Day Bonus</label><input type="number" id="daily-streak" class="input-std text-center" value="50"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[650px]">
                
                <div class="lg:col-span-4 glass-panel flex flex-col h-full overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 backdrop-blur z-10 space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 text-sm"><i class="fa fa-search mr-2 text-slate-400"></i>Mission Source</h3>
                            <div class="flex bg-slate-200 rounded p-1">
                                <button onclick="setSource('stores')" id="src-stores" class="px-3 py-1 text-[10px] font-bold rounded bg-white shadow-sm text-slate-800 transition">Stores</button>
                                <button onclick="setSource('products')" id="src-products" class="px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:bg-slate-100 transition">Items</button>
                            </div>
                        </div>
                        <input type="text" id="search-input" onkeyup="handleSearch(this.value)" placeholder="Search inventory..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-indigo-100 outline-none">
                        <button onclick="scheduleRotation()" class="w-full bg-slate-800 hover:bg-black text-white py-2.5 rounded-lg text-xs font-bold shadow transition flex justify-center items-center gap-2 group">
                            <i class="fa fa-sync-alt group-hover:rotate-180 transition-transform duration-500"></i> Auto-Schedule 24h Batch
                        </button>
                    </div>
                    <div id="item-list-container" class="flex-grow overflow-y-auto p-3 custom-scroll space-y-2 relative bg-white">
                        <div id="item-list-content"></div>
                        <div id="scroll-loader" class="py-4 text-center hidden"><i class="fa fa-circle-notch fa-spin text-indigo-500"></i></div>
                        <div id="sentinel" class="h-4 w-full"></div>
                    </div>
                </div>

                <div class="lg:col-span-5 glass-panel flex flex-col h-full border-t-4 border-t-indigo-500">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center z-10 bg-white">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fa fa-clock mr-2 text-indigo-500"></i>Live Schedule</h3>
                        <span class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-green-100 text-[10px] font-bold text-green-700 border border-green-200"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> SYSTEM ACTIVE</span>
                    </div>
                    <div id="mission-timeline" class="flex-grow overflow-y-auto p-4 custom-scroll space-y-3 bg-slate-50/50"></div>
                </div>

                <div class="lg:col-span-3 glass-panel flex flex-col h-full">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700 text-sm"><i class="fa fa-list-alt mr-2 text-slate-400"></i>Live Feed</h3></div>
                    <div id="transaction-log" class="flex-grow overflow-y-auto p-3 custom-scroll space-y-3 bg-white"></div>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="hidden animate-slide-up">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="glass-panel p-6 relative">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa fa-users text-indigo-500"></i> User Tier Distribution</h3>
                    <div class="h-64 flex items-center justify-center relative" id="chart-tiers-container">
                        <canvas id="chart-tiers"></canvas>
                        <div id="tier-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10"><span class="text-xs font-bold text-slate-500"><i class="fa fa-spinner fa-spin mr-2"></i>Analyzing...</span></div>
                    </div>
                </div>
                <div class="glass-panel p-6 relative">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa fa-chart-area text-emerald-500"></i> Coin Circulation (7 Days)</h3>
                    <div class="h-64 flex items-center justify-center relative" id="chart-flow-container">
                        <canvas id="chart-flow"></canvas>
                        <div id="flow-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10"><span class="text-xs font-bold text-slate-500"><i class="fa fa-spinner fa-spin mr-2"></i>Fetching...</span></div>
                    </div>
                </div>
            </div>
            
            <div class="glass-panel p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa fa-trophy text-yellow-500"></i> Top 10 Loyal Customers</h3>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-100">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                            <tr><th class="px-6 py-4">Rank</th><th class="px-6 py-4">User</th><th class="px-6 py-4">Level</th><th class="px-6 py-4 text-right">Coins Balance</th></tr>
                        </thead>
                        <tbody id="leaderboard-body" class="bg-white divide-y divide-slate-100">
                            <tr><td colspan="4" class="text-center py-6 text-slate-400"><i class="fa fa-spinner fa-spin mr-2"></i> Loading Leaderboard...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-notify" class="hidden animate-slide-up max-w-2xl mx-auto mt-10">
            <div class="glass-panel p-8 border-t-4 border-t-indigo-500">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa fa-paper-plane"></i></div>
                    <h2 class="text-2xl font-black text-slate-800">Push Console</h2>
                    <p class="text-slate-500 text-sm">Send instant alerts to all active devices.</p>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Notification Title</label>
                        <input type="text" id="notif-title" class="input-std text-lg" placeholder="e.g. ⚡ Happy Hour is ON!">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Message Body</label>
                        <textarea id="notif-body" class="input-std h-32 resize-none" placeholder="Get 2x points on all purchases until 6 PM..."></textarea>
                    </div>
                    <button onclick="sendNotification()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 hover:shadow-indigo-200 transition transform active:scale-95">
                        <i class="fa fa-rss mr-2"></i> Send Broadcast
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { renderSidebar, checkAdminAuth, db, showToast } from "./common.js";
        import { collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, orderBy, limit, startAfter, addDoc, serverTimestamp, getDocs, deleteDoc, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        checkAdminAuth();
        renderSidebar('loyalty');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const publicDataPath = `/artifacts/${appId}/public/data`;

        // Chart Instances
        let tierChartInstance = null;
        let flowChartInstance = null;

        // --- TAB SWITCHING ---
        window.switchTab = (tabName) => {
            const tabs = ['command', 'analytics', 'notify'];
            tabs.forEach(t => {
                const el = document.getElementById(`view-${t}`);
                const btn = document.getElementById(`btn-${t}`);
                
                if (t === tabName) {
                    el.classList.remove('hidden');
                    btn.classList.add('active');
                } else {
                    el.classList.add('hidden');
                    btn.classList.remove('active');
                }
            });
            
            if(tabName === 'analytics') loadRealAnalytics();
        };

        // --- SOURCE SWITCHER & SEARCH ---
        let currentSource = 'stores';
        let searchTimeout = null;
        let currentSearchTerm = '';

        window.setSource = (source) => {
            currentSource = source;
            document.getElementById('src-stores').className = source === 'stores' ? "px-3 py-1 text-[10px] font-bold rounded bg-white shadow-sm text-slate-800 transition" : "px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:bg-slate-100 transition";
            document.getElementById('src-products').className = source === 'products' ? "px-3 py-1 text-[10px] font-bold rounded bg-white shadow-sm text-slate-800 transition" : "px-3 py-1 text-[10px] font-bold rounded text-slate-500 hover:bg-slate-100 transition";
            
            // Reset List
            lastVisibleItem = null;
            hasMoreItems = true;
            document.getElementById('item-list-content').innerHTML = '';
            document.getElementById('search-input').value = '';
            currentSearchTerm = '';
            loadItems();
        };

        window.handleSearch = (val) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchTerm = val.toLowerCase();
                // Reset for search
                lastVisibleItem = null;
                hasMoreItems = true;
                document.getElementById('item-list-content').innerHTML = '';
                loadItems();
            }, 500); // 500ms debounce
        };

        // --- CONFIG & LOAD ---
        async function loadConfig() {
            try {
                const snap = await getDoc(doc(db, 'config', 'loyalty_program'));
                if (snap.exists()) {
                    const d = snap.data();
                    document.getElementById('rate-earn').value = d.earnRate || 1;
                    document.getElementById('limit-percent').value = d.maxRedeemPercent || 50;
                    document.getElementById('limit-expiry').value = d.expiryDays || 90;
                    document.getElementById('flash-boost').checked = d.happyHourEnabled || false;
                    document.getElementById('daily-active').checked = d.dailyCheckinEnabled || false;
                    document.getElementById('daily-amount').value = d.dailyReward || 5;
                    document.getElementById('daily-streak').value = d.streakBonus || 50;
                    
                    ['silver', 'gold', 'platinum'].forEach(t => {
                        if(d.tiers?.[t]) {
                            document.getElementById(`tier-${t}-min`).value = d.tiers[t].min;
                            document.getElementById(`tier-${t}-mult`).value = d.tiers[t].multiplier;
                        }
                    });
                }
            } catch(e) { console.error("Config load error", e); }
        }

        window.saveConfig = async () => {
            const btn = document.querySelector('button[onclick="saveConfig()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
            
            const config = {
                earnRate: parseFloat(document.getElementById('rate-earn').value),
                maxRedeemPercent: parseFloat(document.getElementById('limit-percent').value),
                expiryDays: parseInt(document.getElementById('limit-expiry').value),
                happyHourEnabled: document.getElementById('flash-boost').checked,
                dailyCheckinEnabled: document.getElementById('daily-active').checked,
                dailyReward: parseInt(document.getElementById('daily-amount').value),
                streakBonus: parseInt(document.getElementById('daily-streak').value),
                tiers: {
                    silver: { min: parseFloat(document.getElementById('tier-silver-min').value), multiplier: parseFloat(document.getElementById('tier-silver-mult').value) },
                    gold: { min: parseFloat(document.getElementById('tier-gold-min').value), multiplier: parseFloat(document.getElementById('tier-gold-mult').value) },
                    platinum: { min: parseFloat(document.getElementById('tier-plat-min').value), multiplier: parseFloat(document.getElementById('tier-plat-mult').value) }
                },
                updatedAt: serverTimestamp()
            };
            try {
                await setDoc(doc(db, 'config', 'loyalty_program'), config, { merge: true });
                showToast('Configuration Saved!', 'success');
            } catch(e) { showToast(e.message, 'error'); }
            finally { btn.innerHTML = originalHtml; }
        };

        // --- INFINITE SCROLL LIST ---
        let lastVisibleItem = null;
        let isItemsLoading = false;
        let hasMoreItems = true;
        const ITEMS_PER_PAGE = 20;

        async function loadItems(isNextPage = false) {
            if (isItemsLoading || (!hasMoreItems && isNextPage)) return;
            isItemsLoading = true;
            if(isNextPage) document.getElementById('scroll-loader').classList.remove('hidden');

            const listContainer = document.getElementById('item-list-content');
            try {
                let q;
                const colRef = collection(db, publicDataPath, currentSource);
                
                // Note: Simple client-side search filtering if term exists (Firebase doesn't do 'contains' natively well without specific indexes)
                // For production with large data, use Algolia/Typesense. Here we just fetch latest.
                
                if (isNextPage && lastVisibleItem) {
                    q = query(colRef, limit(ITEMS_PER_PAGE), startAfter(lastVisibleItem));
                } else {
                    q = query(colRef, limit(ITEMS_PER_PAGE));
                }

                const snap = await getDocs(q);
                if (snap.empty) {
                    hasMoreItems = false;
                    if (!isNextPage && !currentSearchTerm) listContainer.innerHTML = `<div class="text-center py-10"><div class="bg-slate-50 inline-block p-4 rounded-full mb-2"><i class="fa fa-box-open text-slate-300 text-2xl"></i></div><p class="text-slate-400 text-xs">No items found.</p></div>`;
                } else {
                    lastVisibleItem = snap.docs[snap.docs.length - 1];
                    
                    snap.forEach(d => {
                        const data = d.data();
                        const name = data.storeName || data.name || data.title || 'Unknown';
                        // Simple Client side filter (Not ideal for huge DBs, but works for admin dashboards often)
                        if(currentSearchTerm && !name.toLowerCase().includes(currentSearchTerm)) return;
                        renderItem(d.id, data, listContainer);
                    });
                }
            } catch(e) { console.error(e); }
            finally {
                isItemsLoading = false;
                document.getElementById('scroll-loader').classList.add('hidden');
            }
        }

        function renderItem(id, data, container) {
            const img = data.logoUrl || data.imageUrl || data.bannerImageUrl || 'https://placehold.co/100x100/f1f5f9/94a3b8?text=IMG';
            const name = data.storeName || data.name || data.title || 'Unknown';
            const icon = currentSource === 'stores' ? 'fa-store' : 'fa-box';
            
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg hover:border-indigo-300 hover:shadow-md transition group animate-fade-in cursor-pointer';
            div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="relative shrink-0">
                        <img src="${img}" loading="lazy" class="w-10 h-10 rounded-lg object-cover bg-slate-50 border border-slate-100 group-hover:scale-105 transition-transform">
                        <span class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 border border-gray-100 text-[8px] text-indigo-500 shadow-sm"><i class="fa ${icon}"></i></span>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs font-bold text-slate-700 truncate w-32 md:w-40">${name}</p>
                        <p class="text-[9px] text-slate-400 font-mono">ID: ..${id.substr(-4)}</p>
                    </div>
                </div>
                <button onclick="assignSingle('${id}', '${name.replace(/'/g, "\\'")}', '${currentSource}')" class="w-8 h-8 rounded-lg flex items-center justify-center bg-slate-50 text-slate-400 hover:bg-indigo-600 hover:text-white transition shadow-sm">
                    <i class="fa fa-plus text-xs"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // Intersection Observer for Scroll
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadItems(true);
        }, { root: document.getElementById('item-list-container'), threshold: 0.1 });
        setTimeout(() => { const s = document.getElementById('sentinel'); if(s) observer.observe(s); }, 1000);

        // --- MISSION LOGIC ---
        window.assignSingle = async (id, name, type) => {
            const { value: formValues } = await Swal.fire({
                title: `<span class="text-lg font-bold text-slate-800">Assign Mission</span>`,
                html: `
                    <div class="bg-indigo-50 p-3 rounded-lg mb-4 flex items-center gap-3">
                        <div class="w-8 h-8 bg-indigo-200 text-indigo-700 rounded-full flex items-center justify-center font-bold"><i class="fa ${type === 'stores' ? 'fa-store' : 'fa-box'}"></i></div>
                        <div class="text-left overflow-hidden"><p class="text-xs text-slate-500">Target</p><p class="text-sm font-bold text-slate-800 truncate">${name}</p></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="text-left"><label class="text-[10px] font-bold uppercase text-slate-400">Duration (Sec)</label><input id="swal-sec" type="number" class="w-full border border-gray-300 p-2 rounded-lg text-sm focus:border-indigo-500 outline-none mt-1" value="15"></div>
                        <div class="text-left"><label class="text-[10px] font-bold uppercase text-slate-400">Reward (Pts)</label><input id="swal-rew" type="number" class="w-full border border-gray-300 p-2 rounded-lg text-sm focus:border-indigo-500 outline-none mt-1" value="10"></div>
                    </div>
                    <div class="text-left"><label class="text-[10px] font-bold uppercase text-slate-400">Geofence</label>
                        <select id="swal-region" class="w-full border border-gray-300 p-2 rounded-lg text-sm focus:border-indigo-500 outline-none mt-1 bg-white">
                            <option value="all">All Island</option>
                            <option value="colombo">Colombo District</option>
                            <option value="kandy">Kandy District</option>
                            <option value="galle">Galle District</option>
                        </select>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                confirmButtonText: 'Deploy Mission',
                customClass: { popup: 'rounded-2xl' }
            });

            if(formValues) {
                const seconds = document.getElementById('swal-sec').value;
                const reward = document.getElementById('swal-rew').value;
                const region = document.getElementById('swal-region').value;
                const now = new Date();
                const end = new Date(now.getTime() + (4 * 60 * 60 * 1000)); 

                await addDoc(collection(db, 'loyalty_missions'), {
                    title: type === 'stores' ? `Visit ${name}` : `View Offer: ${name}`,
                    targetId: id, type: type === 'stores' ? 'store' : 'product',
                    reward: parseInt(reward), seconds: parseInt(seconds), region: region,
                    isActive: true, startTime: now, endTime: end, createdAt: serverTimestamp()
                });
                showToast('Mission Deployed successfully', 'success');
            }
        };

        window.scheduleRotation = async () => {
             const btn = document.querySelector('button[onclick="scheduleRotation()"]');
             const original = btn.innerHTML;
             btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generating...'; btn.disabled = true;
             try {
                // Fetch random pool
                const q = query(collection(db, publicDataPath, currentSource), limit(20));
                const snap = await getDocs(q);
                if (snap.empty) throw new Error("No items available to schedule.");
                
                // Shuffle and Pick 6
                const shuffled = snap.docs.sort(() => 0.5 - Math.random()).slice(0, 6);
                const batch = writeBatch(db);
                
                let t = new Date();
                shuffled.forEach(d => {
                    const data = d.data();
                    const name = data.storeName || data.name || 'Item';
                    const end = new Date(t.getTime() + (4*3600*1000)); // 4 hour blocks
                    
                    const newRef = doc(collection(db, 'loyalty_missions'));
                    batch.set(newRef, {
                        title: currentSource === 'stores' ? `Visit ${name}` : `Check Offer: ${name}`,
                        targetId: d.id, type: currentSource === 'stores' ? 'store' : 'product',
                        reward: 10, seconds: 15, region: 'all',
                        isActive: true, startTime: new Date(t), endTime: end, 
                        isAutoScheduled: true, createdAt: serverTimestamp()
                    });
                    t = end; // Next starts when this ends
                });
                await batch.commit(); 
                showToast('24h Schedule Generated!', 'success');
             } catch(e) { showToast(e.message, 'error'); }
             finally { btn.innerHTML = original; btn.disabled = false; }
        };

        // --- REALTIME TIMELINE ---
        function loadTimeline() {
            const q = query(collection(db, 'loyalty_missions'), orderBy('endTime', 'desc'), limit(30));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('mission-timeline');
                container.innerHTML = '';
                
                if(snap.empty) { container.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fa fa-calendar-times text-2xl mb-2"></i><p class="text-xs">No active timeline.</p></div>'; return; }
                
                const now = new Date();
                snap.forEach(doc => {
                    const m = doc.data();
                    const start = m.startTime?.toDate(); 
                    const end = m.endTime?.toDate();
                    const isLive = now >= start && now <= end;
                    const icon = m.type === 'product' ? 'fa-box' : 'fa-store';
                    
                    container.innerHTML += `
                        <div class="relative p-3 rounded-lg border border-slate-200 transition-all hover:shadow-md flex justify-between items-center group ${isLive ? 'bg-white border-l-4 border-l-emerald-500' : 'bg-slate-50 opacity-60 grayscale border-l-4 border-l-slate-300'}">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full ${isLive ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'} flex items-center justify-center text-xs shrink-0 mt-1">
                                    <i class="fa ${icon}"></i>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-0.5">
                                        ${isLive ? '<span class="text-[9px] font-black text-emerald-600 uppercase tracking-wide">● Live Now</span>' : '<span class="text-[9px] font-bold text-slate-400 uppercase">Ended</span>'}
                                        <span class="text-[9px] bg-slate-100 border border-slate-200 px-1.5 rounded text-slate-500">${m.region || 'All'}</span>
                                    </div>
                                    <h4 class="font-bold text-xs text-slate-800 line-clamp-1 w-48">${m.title}</h4>
                                    <p class="text-[10px] text-slate-400 font-mono mt-0.5">${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</p>
                                </div>
                            </div>
                            <button onclick="deleteMission('${doc.id}')" class="w-7 h-7 rounded-full bg-slate-100 text-slate-300 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center opacity-0 group-hover:opacity-100" title="Delete Mission">
                                <i class="fa fa-trash text-xs"></i>
                            </button>
                        </div>
                    `;
                });
            });
        }
        window.deleteMission = async (id) => { 
            if(confirm("Are you sure you want to delete this mission?")) {
                await deleteDoc(doc(db, 'loyalty_missions', id)); 
            }
        };

        // --- ANALYTICS & LOGS ---
        function loadHistory() {
             const q = query(collection(db, 'coin_transactions'), orderBy('timestamp', 'desc'), limit(15));
             onSnapshot(q, (snap) => {
                const c = document.getElementById('transaction-log'); c.innerHTML = '';
                if(snap.empty) { c.innerHTML = '<p class="text-center text-slate-400 text-xs mt-10">No recent activity.</p>'; return; }
                snap.forEach(doc => {
                    const t = doc.data(); const isPlus = t.amount > 0;
                    c.innerHTML += `
                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold shrink-0 ${isPlus ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                            ${isPlus?'+':''}${t.amount}
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs font-bold text-slate-700 truncate">${t.userName || 'User'}</p>
                            <p class="text-[10px] text-slate-400 truncate">${t.reason || t.type}</p>
                        </div>
                        <div class="ml-auto text-[9px] text-slate-300">${t.timestamp ? new Date(t.timestamp.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</div>
                    </div>`;
                });
             });
        }

        async function loadRealAnalytics() {
            const goldMin = parseFloat(document.getElementById('tier-gold-min').value) || 50000;
            const platMin = parseFloat(document.getElementById('tier-plat-min').value) || 150000;

            // 1. Tiers
            try {
                document.getElementById('tier-loading').classList.remove('hidden');
                // Warning: Reading full users collection is expensive. 
                const usersSnap = await getDocs(collection(db, 'users'));
                let silver = 0, gold = 0, platinum = 0;
                usersSnap.forEach(doc => {
                    const coins = doc.data().coins || 0;
                    if (coins >= platMin) platinum++;
                    else if (coins >= goldMin) gold++;
                    else silver++;
                });

                document.getElementById('tier-loading').classList.add('hidden');
                if (tierChartInstance) tierChartInstance.destroy();
                tierChartInstance = new Chart(document.getElementById('chart-tiers'), {
                    type: 'doughnut',
                    data: { 
                        labels: ['Silver', 'Gold', 'Platinum'], 
                        datasets: [{ 
                            data: [silver, gold, platinum], 
                            backgroundColor: ['#e2e8f0', '#fbbf24', '#6366f1'],
                            hoverOffset: 4, borderWidth: 0
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10 } } } } }
                });
            } catch(e) { console.error(e); }

            // 2. Flow
            try {
                document.getElementById('flow-loading').classList.remove('hidden');
                const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const txQuery = query(collection(db, 'coin_transactions'), where('timestamp', '>=', sevenDaysAgo), orderBy('timestamp', 'asc'));
                const txSnap = await getDocs(txQuery);
                
                const dailyTotals = {};
                for(let i=0; i<7; i++) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    dailyTotals[d.toLocaleDateString()] = 0;
                }
                
                txSnap.forEach(doc => {
                    const t = doc.data();
                    if(t.amount > 0 && t.timestamp) {
                        const dateKey = t.timestamp.toDate().toLocaleDateString();
                        if(dailyTotals[dateKey] !== undefined) dailyTotals[dateKey] += t.amount;
                    }
                });

                document.getElementById('flow-loading').classList.add('hidden');
                if (flowChartInstance) flowChartInstance.destroy();
                flowChartInstance = new Chart(document.getElementById('chart-flow'), {
                    type: 'line',
                    data: { 
                        labels: Object.keys(dailyTotals).reverse(), 
                        datasets: [{ 
                            label: 'Coins Minted', 
                            data: Object.values(dailyTotals).reverse(), 
                            borderColor: '#10b981', backgroundColor: (ctx) => {
                                const gradient = ctx.chart.ctx.createLinearGradient(0,0,0,200);
                                gradient.addColorStop(0, 'rgba(16,185,129,0.2)');
                                gradient.addColorStop(1, 'rgba(16,185,129,0)');
                                return gradient;
                            },
                            fill: true, tension: 0.4, pointRadius: 3
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { borderDash: [4, 4], color: '#f1f5f9' } } } }
                });
            } catch(e) { console.error(e); }

            // 3. Leaderboard
            try {
                const q = query(collection(db, 'users'), orderBy('coins', 'desc'), limit(10));
                const snap = await getDocs(q);
                const body = document.getElementById('leaderboard-body');
                body.innerHTML = '';
                if(snap.empty) { body.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400">No users.</td></tr>'; return; }
                
                let rank = 1;
                snap.forEach(d => {
                    const u = d.data();
                    const coins = u.coins || 0;
                    let tierConfig = { label: 'Silver', color: 'bg-slate-100 text-slate-500' };
                    if (coins >= platMin) tierConfig = { label: 'Platinum', color: 'bg-indigo-100 text-indigo-600' };
                    else if (coins >= goldMin) tierConfig = { label: 'Gold', color: 'bg-yellow-100 text-yellow-700' };

                    body.innerHTML += `
                        <tr class="hover:bg-slate-50/50 transition">
                            <td class="px-6 py-4 font-bold text-slate-400">#${rank++}</td>
                            <td class="px-6 py-4 font-bold text-slate-700 flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs text-slate-500 font-bold">${u.name ? u.name.charAt(0) : '?'}</div>
                                ${u.name || 'Unknown'}
                            </td>
                            <td class="px-6 py-4"><span class="${tierConfig.color} px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider">${tierConfig.label}</span></td>
                            <td class="px-6 py-4 text-right font-black text-emerald-600">${coins.toLocaleString()}</td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        // --- NOTIFICATION BROADCAST ---
        window.sendNotification = async () => {
            const title = document.getElementById('notif-title').value;
            const body = document.getElementById('notif-body').value;
            if(!title || !body) return showToast('Please enter title and message.', 'warning');
            
            const btn = document.querySelector('button[onclick="sendNotification()"]');
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Sending...';
            try {
                await addDoc(collection(db, 'notifications_queue'), { title, body, target: 'all', status: 'pending', createdAt: serverTimestamp() });
                showToast('Broadcast queued successfully.', 'success');
                document.getElementById('notif-title').value = '';
                document.getElementById('notif-body').value = '';
            } catch(e) { showToast('Error sending broadcast.', 'error'); }
            finally { btn.innerHTML = '<i class="fa fa-rss mr-2"></i> Send Broadcast'; }
        };

        // Init
        loadConfig();
        loadItems(); 
        loadTimeline();
        loadHistory();

    </script>
</body>
</html>